

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="title: 动画相关date: 2022-07-21 13:27:33tags: View 动画相关属性动画为什么引入属性动画  在Android中,动画分为两类:视图动画(View Animation)和属性动画(Property Animation).其中,View Animation包括Tween Animation(补间动画)和Frame Animation(逐帧动画);Property">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2022/10/19/%E5%8A%A8%E7%94%BB%E7%9B%B8%E5%85%B3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="title: 动画相关date: 2022-07-21 13:27:33tags: View 动画相关属性动画为什么引入属性动画  在Android中,动画分为两类:视图动画(View Animation)和属性动画(Property Animation).其中,View Animation包括Tween Animation(补间动画)和Frame Animation(逐帧动画);Property">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/mRjNFA2nMCEJYbz.png">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/OWHiDkyCujQlSPA.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/2zw9v3yabpIiCG6.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Bzu8V7Dsey3oKrZ.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/UHwNOTLXpsChAb8.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/yBCnQiZLUIRxmwA.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/iCHNk6EpMmIARJu.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/bDlG15fxipUZw8d.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MEUAOG9qiWmwY4z.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Tt9d5vwrnPjYlBu.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/FZYJeW2QntgCyED.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MyEvaluator.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/ofObject.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/gF1P5G4cJeTI87p.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/dh1uGvkzgPVJi4p.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/cr1awb7nK4MvixX.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/RbSHJwYFsu3Lk46.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/1OZoxCjlnV8YIUb.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/IEWRNeXbdMpHjYx.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/iGaWb2kcLHNBS6t.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/jRHqCGsl7rmWnpN.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/A6eql3FxIhgyS8H.png">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Transition-Explode.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Transition-Slide.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Transition-Fade.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Activity-%E5%85%B1%E4%BA%AB%E5%85%83%E7%B4%A0.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/wE2KrFdqeT8z4BO.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Shared_Transition_no_Postpone.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Shared_transition_no_exit_retreen.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/TransitionManager-%E5%8A%A8%E7%94%BB.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/%E8%87%AA%E5%AE%9A%E4%B9%89Transition.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Shared_transition_final.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MaterialElevationScale.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MaterialSharedAxis-X.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MaterialSharedAxis-Y.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MaterialSharedAxis-Z.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MaterialFadeThrough.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/View-MaterialContainerTransform.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/ehwoWQDFGOZb8kz.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/BpNo46EwZGQaCqr.webp">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/ViewPager2-%E5%88%87%E6%8D%A2%E5%8A%A8%E7%94%BB.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/%E5%B8%83%E5%B1%80%E6%9B%B4%E6%96%B0%E5%8A%A8%E7%94%BB.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/XqHFONVlIwhcURk.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/WzescPJXxM7lGrI.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/uoXHKFhv7nsBc9V.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/mvVMbNucZqQY1Wd.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/xt2P8iQW5mXjfwv.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/TGzJo72are9R63b.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/aCVpfHsGh9w4QOZ.gif">
<meta property="og:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/ADLPQNUysHxIpz1.png">
<meta property="article:published_time" content="2022-10-19T08:50:50.221Z">
<meta property="article:modified_time" content="2022-10-19T09:10:40.587Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/mRjNFA2nMCEJYbz.png">
  
  
  
  <title>Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text=""></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-19 16:50" pubdate>
          October 19, 2022 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          78k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          654 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none"></h1>
            
            
              <div class="markdown-body">
                
                <p>title: 动画相关<br>date: 2022-07-21 13:27:33<br>tags: View</p>
<h1 id="动画相关"><a href="#动画相关" class="headerlink" title="动画相关"></a>动画相关</h1><h2 id="属性动画"><a href="#属性动画" class="headerlink" title="属性动画"></a>属性动画</h2><h3 id="为什么引入属性动画"><a href="#为什么引入属性动画" class="headerlink" title="为什么引入属性动画"></a>为什么引入属性动画</h3><p>  在Android中,动画分为两类:<strong>视图动画</strong>(<code>View Animation</code>)和<strong>属性动画</strong>(<code>Property Animation</code>).其中,<code>View Animation</code>包括<code>Tween Animation</code>(<strong>补间动画</strong>)和<code>Frame Animation</code>(<strong>逐帧动画</strong>);<code>Property Animation</code>包括<code>ValueAnimation</code>和<code>ObjectAnimator</code>.</p>
<p>  属性动画（<code>Property Animation</code>）是在 Android 3.0后才提供的一种全新动画模式</p>
<p>  首先来看一下补间动画的缺陷:</p>
<ul>
<li><p>补间动画是<strong>只能够作用在View上</strong>的。我们可以对一个Button、TextView、或者其它任何继承自View的组件进行动画操作，但是如果我们想要对一个非View的对象进行动画操作，补间动画就不起作用了。</p>
</li>
<li><p>补间动画只能够实现<strong>移动、缩放、旋转和淡入淡出</strong>这四种动画操作，那如果我们想对View的背景色进行动态地改变,补间动画是不能实现的. 补间动画机制就是使用硬编码的方式来完成的，功能限定死就是这些，基本上<strong>没有任何扩展性</strong>。</p>
</li>
<li><p>补间动画只是<strong>改变了View的显示效果而已，而不会真正去改变View的属性</strong>。比如说，现在屏幕的左上角有一个按钮，然后我们通过补间动画将它移动到了屏幕的右下角，现在你可以去点击一下这个按钮，点击事件是不会触发的，因为实际上这个按钮还是停留在屏幕的左上角，只不过补间动画将这个按钮绘制到了屏幕的右下角而已。</p>
<p>新引入的<strong>属性动画</strong>机制已经不再是针对于View来设计的了，也不限定于只能实现移动、缩放、  旋转和淡入淡出这几种动画操作，同时也不再只是一种视觉上的动画效果了。它实际上是一种不断地对<strong>值</strong>进行操作的机制，并将值赋值到指定对象的指定属性上，可以是任意对象的任意属性。</p>
</li>
</ul>
<p><strong>属性动画工作原理[重点]</strong></p>
<p><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/mRjNFA2nMCEJYbz.png" srcset="/img/loading.gif" lazyload alt="安卓属性动画工作原理"></p>
<p><a target="_blank" rel="noopener" href="https://www.processon.com/view/link/62cbbd0763768906c5087f89">安卓属性动画工作原理 -查看大图</a></p>
<h3 id="ValueAnimator的简单使用"><a href="#ValueAnimator的简单使用" class="headerlink" title="ValueAnimator的简单使用"></a>ValueAnimator的简单使用</h3><p>  ValueAnimator这个动画是针对<strong>值</strong>的. ValueAnimator不会对控件执行任何操作,我们可以给它设定从哪个值运动到哪个值,通过监听这些值的渐变过程来自己操作控件.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 步骤1：设置动画属性的初始值 &amp; 结束值</span><br><span class="hljs-keyword">val</span> animator = ValueAnimator.ofInt(<span class="hljs-number">0</span>, <span class="hljs-number">400</span>)<br><span class="hljs-comment">// ofInt（）作用有两个</span><br><span class="hljs-comment">// 1. 创建动画实例</span><br><span class="hljs-comment">// 2. 将传入的Int参数进行平滑过渡:此处传入0和400,表示将值从0平滑过渡到400</span><br><span class="hljs-comment">// 如果传入了多个Int参数 ,如:a,b,c ,则是先从a过渡到b,再从b过渡到C，以此类推</span><br><span class="hljs-comment">// ValueAnimator.ofInt()内置了整型估值器,关于自定义估值器将在下面讲解</span><br><br><span class="hljs-comment">// 步骤2：设置动画的播放各种属性</span><br><span class="hljs-comment">// 设置动画运行的时长</span><br>animator.duration = <span class="hljs-number">500</span><br><span class="hljs-comment">// 设置动画延迟播放时间</span><br>animator.startDelay = <span class="hljs-number">200</span><br><span class="hljs-comment">// 设置动画重复播放次数</span><br><span class="hljs-comment">// 动画播放次数 = infinite时,动画无限重复</span><br>animator.repeatCount = <span class="hljs-number">0</span><br><span class="hljs-comment">// 设置重复播放动画模式</span><br><span class="hljs-comment">// ValueAnimator.RESTART(默认):正序重放</span><br><span class="hljs-comment">// ValueAnimator.REVERSE:倒序回放</span><br>animator.repeatMode = ValueAnimator.RESTART<br><span class="hljs-comment">// 设置插值器</span><br>animator.interpolator = AccelerateInterpolator()<br><span class="hljs-comment">//设置估值器,对于ofInt()和ofFloat(系统都有默认的估值器,只有ofObject才需要我们自己设置)</span><br><span class="hljs-comment">//animator.setEvaluator(IntEvaluator())</span><br><br><span class="hljs-comment">// 步骤3：将改变的值手动赋值给对象的属性值：通过动画的更新监听器</span><br><span class="hljs-comment">// 设置&#x27;值&#x27;的更新监听器,值每次改变、变化一次,该方法就会被调用一次</span><br>animator.addUpdateListener &#123; animation -&gt;<br>    <span class="hljs-comment">// 获得改变后的值</span><br>    <span class="hljs-keyword">val</span> currentValue = animation.animatedValue <span class="hljs-keyword">as</span> <span class="hljs-built_in">Int</span><br>    <span class="hljs-comment">// 步骤4：将改变后的值赋给对象的属性值</span><br>    View.setproperty（currentValue）；<br>    <span class="hljs-comment">// 步骤5：刷新视图，即重新绘制，从而实现动画效果</span><br>    View.requestLayout();<br>&#125;<br><span class="hljs-comment">// 启动动画</span><br>animator.start()<br></code></pre></td></tr></table></figure>

<p>效果图</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/OWHiDkyCujQlSPA.gif" srcset="/img/loading.gif" lazyload alt="demo1" style="zoom: 50%;" />

<h4 id="ofInt"><a href="#ofInt" class="headerlink" title="ofInt()"></a><code>ofInt</code>()</h4><p>  首先看一下步骤1的ofInt()的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ValueAnimator <span class="hljs-title function_">ofInt</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">int</span>... values)</span> &#123;<br>    	<span class="hljs-comment">// 创建动画对象</span><br>        <span class="hljs-type">ValueAnimator</span> <span class="hljs-variable">anim</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueAnimator</span>();<br>    	<span class="hljs-comment">// 将传入的值赋值给动画对象</span><br>        anim.setIntValues(values);<br>        <span class="hljs-comment">// 返回动画</span><br>        <span class="hljs-keyword">return</span> anim;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>ValueAnimator.ofInt（）</code>与<code>ValueAnimator.oFloat（）</code>仅仅只是在估值器上的区别：</p>
<ul>
<li><code>ValueAnimator.oFloat（）</code>采用默认的浮点型估值器 (<code>FloatEvaluator</code>)</li>
<li><code>ValueAnimator.ofInt（）</code>采用默认的整型估值器（<code>IntEvaluator</code>）</li>
</ul>
<h4 id="插值器-Interpolator"><a href="#插值器-Interpolator" class="headerlink" title="插值器(Interpolator)"></a>插值器(Interpolator)</h4><p>  估值器是设置从初始值到结束值的逻辑</p>
<ul>
<li><p>插值器(Interpolator)决定<strong>值</strong>的变化速率(匀速,加速…)</p>
</li>
<li><p>估值器(TypeEvaluator)决定<strong>值</strong>的具体变化数值</p>
</li>
</ul>
<p>一些常用的插值器<a name="常用的插值器"></a></p>
<table>
<thead>
<tr>
<th align="left">插值器</th>
<th align="left">效果</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AccelerateDecelerateInterpolator</td>
<td align="left">在动画开始与结束的地方速率改变比较慢，在中间的时候加速</td>
</tr>
<tr>
<td align="left">AccelerateInterpolator</td>
<td align="left">在动画开始的地方速率改变比较慢，然后开始加速</td>
</tr>
<tr>
<td align="left">AnticipateInterpolator</td>
<td align="left">开始的时候向后然后向前甩</td>
</tr>
<tr>
<td align="left">AnticipateOvershootInterpolator</td>
<td align="left">开始的时候向后然后向前甩一定值后返回最后的值</td>
</tr>
<tr>
<td align="left">BounceInterpolator</td>
<td align="left">动画结束的时候弹起</td>
</tr>
<tr>
<td align="left">CycleInterpolator</td>
<td align="left">动画循环播放特定的次数，速率改变沿着正弦曲线</td>
</tr>
<tr>
<td align="left">DecelerateInterpolator</td>
<td align="left">在动画开始的地方快然后慢</td>
</tr>
<tr>
<td align="left">LinearInterpolator</td>
<td align="left">以常量速率改变</td>
</tr>
<tr>
<td align="left">OvershootInterpolator</td>
<td align="left">向前甩一定值后再回到原来位置</td>
</tr>
</tbody></table>
<p>  效果图:</p>
<table>
<thead>
<tr>
<th>AccelerateDecelerateInterpolator</th>
<th>AccelerateInterpolator</th>
<th>AnticipateInterpolator</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/2zw9v3yabpIiCG6.gif" srcset="/img/loading.gif" lazyload alt="AccelerateDecelerateInterpolator" style="zoom: 33%;" /></td>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Bzu8V7Dsey3oKrZ.gif" srcset="/img/loading.gif" lazyload alt="AccelerateInterpolator" style="zoom: 33%;" /></td>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/UHwNOTLXpsChAb8.gif" srcset="/img/loading.gif" lazyload alt="AnticipateInterpolator" style="zoom: 33%;" /></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>AnticipateOvershootInterpolator</th>
<th>BounceInterpolator</th>
<th>CycleInterpolator</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/yBCnQiZLUIRxmwA.gif" srcset="/img/loading.gif" lazyload alt="AnticipateOvershootInterpolator" style="zoom: 33%;" /></td>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/iCHNk6EpMmIARJu.gif" srcset="/img/loading.gif" lazyload alt="BounceInterpolator" style="zoom: 33%;" /></td>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/bDlG15fxipUZw8d.gif" srcset="/img/loading.gif" lazyload alt="CycleInterpolator" style="zoom: 33%;" /></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>DecelerateInterpolator</th>
<th>OvershootInterpolator</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MEUAOG9qiWmwY4z.gif" srcset="/img/loading.gif" lazyload alt="DecelerateInterpolator" style="zoom: 33%;" /></td>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Tt9d5vwrnPjYlBu.gif" srcset="/img/loading.gif" lazyload alt="OvershootInterpolator" style="zoom: 33%;" /></td>
</tr>
</tbody></table>
<p> 先来看一下系统自带的插值器是如何实现的,如LinearInterpolator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinearInterpolator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseInterpolator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NativeInterpolator</span> <br>    <span class="hljs-comment">// 实现了BaseInterpolator接口</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LinearInterpolator</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LinearInterpolator</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">float</span> <span class="hljs-title function_">getInterpolation</span><span class="hljs-params">(<span class="hljs-type">float</span> input)</span> &#123;<br>        <span class="hljs-comment">//直接把input返回,以当前动画进度作为动画的数值进度,这也就表示当前动画的数值进度与动画进度的时间一致,所以LinearInterpolator的数值进度是匀速增加的</span><br>        <span class="hljs-keyword">return</span> input;<br>    &#125;<br> <br>&#125;<br><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseInterpolator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Interpolator</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseInterpolator</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Stub!&quot;</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Interpolator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TimeInterpolator</span> &#123;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>​    <code>LinearInterpolator</code>最终实现了<code>TimeInterpolator</code>,再看一下<code>TImeInterpolator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TimeInterpolator</span> &#123;<br>    <span class="hljs-comment">//参数var1:Float类型,取值范围0~1,表示当前动画的进度</span><br>    <span class="hljs-comment">//返回值:表示当前时间想要显示的进度,取值可以超过1,也可以小于0.超过1表示已超过目标,小于0表示小于开始位置</span><br>    <span class="hljs-type">float</span> <span class="hljs-title function_">getInterpolation</span><span class="hljs-params">(<span class="hljs-type">float</span> var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>  :warning:注意: <strong>input</strong>参数与任何我们设定的值没有关系,只与时间有关,随着时间的推移,动画的进度也自然的增加,input参数就代表了当前动画的进度,而返回值则表示动画的的当前数值进度.</p>
<p>  接下来我们自定义一个插值器,从上面分析来看,我们只需实现<code>TimeInterpolator</code>接口就行</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyInterpolator</span> : <span class="hljs-type">Interpolator</span> &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInterpolation</span><span class="hljs-params">(input: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> - input<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>  效果图:就是反转一下动画</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/FZYJeW2QntgCyED.gif" srcset="/img/loading.gif" lazyload alt="MyInterpolator" style="zoom: 50%;" />

<h4 id="估值器-TypeEvaluator"><a href="#估值器-TypeEvaluator" class="headerlink" title="估值器(TypeEvaluator)"></a>估值器(TypeEvaluator)</h4><p>​    Evaluator是一个转换器,把插值器得到的小数进度转换为对应的数值位置</p>
<p>​    先看一下<code>ofInt()</code>的估值器<code>IntEvaluator</code>怎么实现的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// InttEvaluator实现了TypeEvaluator接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntEvaluator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TypeEvaluator</span>&lt;Integer&gt; &#123;<br>    <span class="hljs-comment">// 重写了evaluate方法</span><br>    <span class="hljs-comment">// 参数ftaction:动画的完成度(从插值器中返回的值)</span><br>    <span class="hljs-comment">// startValue,endValue:动画的初始值和结束值</span><br>    <span class="hljs-comment">// 返回值就是当前数值进度所对应的具体数值</span><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">evaluate</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction, Integer startValue, Integer endValue)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">startInt</span> <span class="hljs-operator">=</span> startValue;<br>        <span class="hljs-comment">// 当前的值 = 开始的值 + 显示进度 * (结束值 - 开始值)</span><br>        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)(startInt + fraction * (endValue - startInt));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​    </p>
<p>  对于<code>ValueAnimator.ofObject（）</code>，没有系统默认实现，因为对<strong>对象</strong>的动画操作比较复杂，我们需自定义估值器,来告知系统如何进行从<em>初始对象</em>过渡到<em>结束对象</em>的逻辑</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 首先实现TypeEvaluator接口</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyEvaluator</span> : <span class="hljs-type">TypeEvaluator</span>&lt;<span class="hljs-type">Int</span>&gt; &#123;<br>    <span class="hljs-comment">// 重写rvaluator方法</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">evaluate</span><span class="hljs-params">(fraction: <span class="hljs-type">Float</span>, startValue: <span class="hljs-type">Int</span>, endValue: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> &#123;<br>        <span class="hljs-comment">// 将正常的计算方法反转</span><br>        <span class="hljs-comment">// 当前的值 = 结束的值 - 显示进度 * (结束值 - 开始值)</span><br>        <span class="hljs-keyword">return</span> (endValue - fraction * (endValue - startValue)).toInt()<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>  这个与上面自定义插值器显示的效果一样</p>
<p>  效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MyEvaluator.gif" srcset="/img/loading.gif" lazyload alt="MyEvaluator" style="zoom: 50%;" />



<p>  系统中还有一个估值器,<code>ArgbEvaluator</code>是用来实现颜色过渡转换,源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgbEvaluator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TypeEvaluator</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ArgbEvaluator</span> <span class="hljs-variable">sInstance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgbEvaluator</span>();<br>    <br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">evaluate</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction, Object startValue, Object endValue)</span> &#123;<br>        <span class="hljs-comment">//这个就和编程基础Ⅱ里求ip地址一样</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">startInt</span> <span class="hljs-operator">=</span> (Integer) startValue;<br>        <span class="hljs-type">float</span> <span class="hljs-variable">startA</span> <span class="hljs-operator">=</span> ((startInt &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>) / <span class="hljs-number">255.0f</span>;<br>        <span class="hljs-type">float</span> <span class="hljs-variable">startR</span> <span class="hljs-operator">=</span> ((startInt &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>) / <span class="hljs-number">255.0f</span>;<br>        <span class="hljs-type">float</span> <span class="hljs-variable">startG</span> <span class="hljs-operator">=</span> ((startInt &gt;&gt;  <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>) / <span class="hljs-number">255.0f</span>;<br>        <span class="hljs-type">float</span> <span class="hljs-variable">startB</span> <span class="hljs-operator">=</span> ( startInt        &amp; <span class="hljs-number">0xff</span>) / <span class="hljs-number">255.0f</span>;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">endInt</span> <span class="hljs-operator">=</span> (Integer) endValue;<br>        <span class="hljs-type">float</span> <span class="hljs-variable">endA</span> <span class="hljs-operator">=</span> ((endInt &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>) / <span class="hljs-number">255.0f</span>;<br>        <span class="hljs-type">float</span> <span class="hljs-variable">endR</span> <span class="hljs-operator">=</span> ((endInt &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>) / <span class="hljs-number">255.0f</span>;<br>        <span class="hljs-type">float</span> <span class="hljs-variable">endG</span> <span class="hljs-operator">=</span> ((endInt &gt;&gt;  <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>) / <span class="hljs-number">255.0f</span>;<br>        <span class="hljs-type">float</span> <span class="hljs-variable">endB</span> <span class="hljs-operator">=</span> ( endInt        &amp; <span class="hljs-number">0xff</span>) / <span class="hljs-number">255.0f</span>;<br><br>        <span class="hljs-comment">// 自然界线性增长的亮度是条曲线,需要转换为LinearRGB(计算机视觉)</span><br>        <span class="hljs-comment">// 计算时用LinearRGB,显示时用sRGB</span><br>        startR = (<span class="hljs-type">float</span>) Math.pow(startR, <span class="hljs-number">2.2</span>);<br>        startG = (<span class="hljs-type">float</span>) Math.pow(startG, <span class="hljs-number">2.2</span>);<br>        startB = (<span class="hljs-type">float</span>) Math.pow(startB, <span class="hljs-number">2.2</span>);<br><br>        endR = (<span class="hljs-type">float</span>) Math.pow(endR, <span class="hljs-number">2.2</span>);<br>        endG = (<span class="hljs-type">float</span>) Math.pow(endG, <span class="hljs-number">2.2</span>);<br>        endB = (<span class="hljs-type">float</span>) Math.pow(endB, <span class="hljs-number">2.2</span>);<br>        <br>        <span class="hljs-comment">// compute the interpolated color in linear space</span><br>        <span class="hljs-comment">// 转换公式与前面IntEvaluator一致</span><br>        <span class="hljs-type">float</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> startA + fraction * (endA - startA);<br>        <span class="hljs-type">float</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> startR + fraction * (endR - startR);<br>        <span class="hljs-type">float</span> <span class="hljs-variable">g</span> <span class="hljs-operator">=</span> startG + fraction * (endG - startG);<br>        <span class="hljs-type">float</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> startB + fraction * (endB - startB);<br><br>        <span class="hljs-comment">// convert back to sRGB in the [0..255] range</span><br>        <span class="hljs-comment">// 归一化</span><br>        a = a * <span class="hljs-number">255.0f</span>;<br>        r = (<span class="hljs-type">float</span>) Math.pow(r, <span class="hljs-number">1.0</span> / <span class="hljs-number">2.2</span>) * <span class="hljs-number">255.0f</span>;<br>        g = (<span class="hljs-type">float</span>) Math.pow(g, <span class="hljs-number">1.0</span> / <span class="hljs-number">2.2</span>) * <span class="hljs-number">255.0f</span>;<br>        b = (<span class="hljs-type">float</span>) Math.pow(b, <span class="hljs-number">1.0</span> / <span class="hljs-number">2.2</span>) * <span class="hljs-number">255.0f</span>;<br><br>        <span class="hljs-keyword">return</span> Math.round(a) &lt;&lt; <span class="hljs-number">24</span> | Math.round(r) &lt;&lt; <span class="hljs-number">16</span> | Math.round(g) &lt;&lt; <span class="hljs-number">8</span> | Math.round(b);<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure>

<h4 id="ofObject"><a href="#ofObject" class="headerlink" title="ofObject()"></a><code>ofObject</code>()</h4><p>  <code>ifInt()</code>和<code>ofFloat()</code>都有系统内置的估值器(<code>FloatEvaluator</code>&amp;<code>IntEvaluato</code>r),但<code>ofObject()</code>没有系统默认的实现,因此,需要我们自定义估值器(<code>TypeEvaluator</code>)来实现从初始对象过渡到结束对象的逻辑.</p>
<p>  先看看<code>ofObject()</code>的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 第一个参数是自定义的估值器,第二个是可变长参数 </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ValueAnimator <span class="hljs-title function_">ofObject</span><span class="hljs-params">(TypeEvaluator evaluator, Object... values)</span> &#123;<br>        <span class="hljs-type">ValueAnimator</span> <span class="hljs-variable">anim</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueAnimator</span>();<br>        anim.setObjectValues(values);<br>        anim.setEvaluator(evaluator);<br>        <span class="hljs-keyword">return</span> anim;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>下面看一个例子,一个抛球的动画</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 用Point记录球的位置</span><br><span class="hljs-keyword">val</span> animator = ValueAnimator.ofObject(FallingBallEvaluator(), Point(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), Point(<span class="hljs-number">500</span>, <span class="hljs-number">500</span>))<br>        animator.addUpdateListener &#123; animation -&gt;<br>            <span class="hljs-keyword">val</span> mCurPoint = animation.animatedValue <span class="hljs-keyword">as</span> Point<br>            ball.layout(<br>                mCurPoint.x,<br>                mCurPoint.y,<br>                mCurPoint.x + ball.width,<br>                mCurPoint.y + ball.height<br>            )<br>        &#125;<br>        animator.duration = <span class="hljs-number">2000</span><br>        animator.start()<br>    &#125;<br><br><span class="hljs-comment">//自定义的估值器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FallingBallEvaluator</span> : <span class="hljs-type">TypeEvaluator</span>&lt;<span class="hljs-type">Point</span>&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> point = Point()<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">evaluate</span><span class="hljs-params">(fraction: <span class="hljs-type">Float</span>, startValue: <span class="hljs-type">Point</span>, endValue: <span class="hljs-type">Point</span>)</span></span>: Point &#123;<br>        point.x = (startValue.x + fraction * (endValue.x - startValue.x)).toInt()<br>        <span class="hljs-comment">// y轴下落比x轴快</span><br>        <span class="hljs-keyword">if</span> (fraction * <span class="hljs-number">2</span> &lt;= <span class="hljs-number">1</span>) &#123;<br>            point.y = (startValue.y + fraction * <span class="hljs-number">2</span> * (endValue.y - startValue.y)).toInt()<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            point.y = endValue.y<br>        &#125;<br>        <span class="hljs-keyword">return</span> point<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>  效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/ofObject.gif" srcset="/img/loading.gif" lazyload alt="ofObject" style="zoom: 50%;" />

<h3 id="ObjectAnimator的简单使用"><a href="#ObjectAnimator的简单使用" class="headerlink" title="ObjectAnimator的简单使用"></a>ObjectAnimator的简单使用</h3><p>  <code>ObjectAnimator</code>与 <code>ValueAnimator</code>类的区别：</p>
<ul>
<li><code>ValueAnimator</code> 类是先改变值，然后<strong>手动赋值</strong>给对象的属性从而实现动画；是<strong>间接</strong>对<strong>对象</strong>属性进行操作</li>
<li><code>ObjectAnimator</code> 类是先改变值，然后<strong>自动赋值</strong>给对象的属性从而实现动画；是<strong>直接</strong>对 <strong>对象</strong>属性进行操作</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//因为ObjectAnimator继承ValueAnimator,所以二者的用法很像</span><br><span class="hljs-comment">//这里ofFloat的第一参数是指定要操作哪个控件,第二个参数是这个控件的那个属性,第三个参数是可变长参数,是指这个属性值如何变化</span><br><span class="hljs-keyword">val</span> animator = ObjectAnimator.ofFloat(<span class="hljs-keyword">object</span>, property, values)<br>	animator.duration = <span class="hljs-number">500</span><br>        animator.start()<br></code></pre></td></tr></table></figure>

<p>下面看几个例子</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">button1.setOnClickListener &#123;<br>    <span class="hljs-comment">//从0旋转到360°</span><br>    <span class="hljs-keyword">val</span> animator = ObjectAnimator.ofFloat(textView, <span class="hljs-string">&quot;rotation&quot;</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">360f</span>)<br>    animator.duration = <span class="hljs-number">1000</span><br>    animator.start()<br>&#125;<br>button2.setOnClickListener &#123;<br>    <span class="hljs-comment">//在X轴上平移300f</span><br>    <span class="hljs-keyword">val</span> curTranslationX = textView.translationX<br>    <span class="hljs-keyword">val</span> animator = ObjectAnimator.ofFloat(<br>        textView,<br>        <span class="hljs-string">&quot;translationX&quot;</span>,<br>        curTranslationX,<br>        <span class="hljs-number">300f</span>,<br>        curTranslationX<br>    )<br>    animator.duration = <span class="hljs-number">1000</span><br>    animator.start()<br>&#125;<br>button3.setOnClickListener &#123;<br>    <span class="hljs-comment">//在X轴上放大2倍再还原</span><br>    <span class="hljs-keyword">val</span> animator = ObjectAnimator.ofFloat(textView, <span class="hljs-string">&quot;scaleX&quot;</span>, <span class="hljs-number">1f</span>, <span class="hljs-number">3f</span>, <span class="hljs-number">1f</span>)<br>    animator.duration = <span class="hljs-number">1000</span><br>    animator.start()<br><br>&#125;<br>button4.setOnClickListener &#123;<br>    <span class="hljs-comment">//透明度从1到0再到1</span><br>    <span class="hljs-keyword">val</span> animator = ObjectAnimator.ofFloat(textView, <span class="hljs-string">&quot;alpha&quot;</span>, <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>)<br>    animator.duration = <span class="hljs-number">1000</span><br>    animator.start()<br>&#125;<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<table>
<thead>
<tr>
<th>旋转</th>
<th>平移</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/gF1P5G4cJeTI87p.gif" srcset="/img/loading.gif" lazyload alt="ObjectAnimator-旋转" style="zoom:33%;" /></td>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/dh1uGvkzgPVJi4p.gif" srcset="/img/loading.gif" lazyload alt="ObjectAnimator-平移" style="zoom:33%;" /></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>透明</th>
<th>缩放</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/cr1awb7nK4MvixX.gif" srcset="/img/loading.gif" lazyload alt="ObjectAnimator-透明" style="zoom: 33%;" /></td>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/RbSHJwYFsu3Lk46.gif" srcset="/img/loading.gif" lazyload alt="ObjectAnimator-缩放" style="zoom:33%;" /></td>
</tr>
</tbody></table>
<p>常用的属性值</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>Rotation</td>
<td>绕Z轴旋转</td>
</tr>
<tr>
<td>RotationY</td>
<td>绕Y轴旋转</td>
</tr>
<tr>
<td>RotationX</td>
<td>绕X轴旋转</td>
</tr>
<tr>
<td>TranslationX</td>
<td>在X轴上平移</td>
</tr>
<tr>
<td>TranslationY</td>
<td>在Y轴上平移</td>
</tr>
<tr>
<td>ScaleX</td>
<td>在X轴上缩放</td>
</tr>
<tr>
<td>ScaleY</td>
<td>在Y轴上缩放</td>
</tr>
<tr>
<td>Alpha</td>
<td>透明度</td>
</tr>
</tbody></table>
<h4 id="自定义ObjectAnimator属性"><a href="#自定义ObjectAnimator属性" class="headerlink" title="自定义ObjectAnimator属性"></a>自定义ObjectAnimator属性</h4><p>  先理一下<code>ObjectAnimator</code>的动画设置流程:<code>OnjectAnimator</code>需要指定操作的控件对象,在动画开始后,先到控件类中去寻找设置属性所对应的<code>set()</code>函数,然后把动画中间值作为参数传给这个<code>set()</code>函数并执行它.所以我们自定义的控件中肯定存在一个<code>set()</code>函数与我们自定义属性相对应.</p>
<p>  还是前面那个抛球的例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//先从ImageView派生一个类表示球,并指定一个set函数</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FallingBallImageView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ImageView</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FallingBallImageView</span><span class="hljs-params">(Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs)</span> &#123;<br>        <span class="hljs-built_in">super</span>(context, attrs);<br>    &#125;<br><br>    <span class="hljs-comment">//set函数对应的属性是fallingPos或FallingPos</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFallingPos</span><span class="hljs-params">(Point pos)</span> &#123;<br>        layout(pos.x, pos.y, pos.x + getWidth(), pos.y + getHeight());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//ObjectAnimation操作的控件是ball2,对应的属性是fallingPos,值从当前点运动到点(ball2.x-500, 500),其中自定义的FallingBallEvaluator和前面的一致</span><br><span class="hljs-keyword">val</span> animator = ObjectAnimator.ofObject(<br>                ball2,<br>                <span class="hljs-string">&quot;fallingPos&quot;</span>,<br>                FallingBallEvaluator(),<br>                Point(ball2.x.toInt(), <span class="hljs-number">0</span>),<br>                Point(ball2.x.toInt()-<span class="hljs-number">500</span>, <span class="hljs-number">500</span>)<br>            )<br>            animator.duration = <span class="hljs-number">1000</span><br>            animator.start()<br></code></pre></td></tr></table></figure>

<p>  效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/1OZoxCjlnV8YIUb.gif" srcset="/img/loading.gif" lazyload alt="自定义ObjectAnimator属性" style="zoom: 50%;" />



<h4 id="关于set-amp-get"><a href="#关于set-amp-get" class="headerlink" title="关于set()&amp;get()"></a>关于<code>set()</code>&amp;<code>get()</code></h4><p>  <code>ObjectAnimator</code>类自动赋给对象的属性的本质是调用该对象属性的<code>set()&amp;get()</code>方法进行赋值,所以，<code>ObjectAnimator.ofFloat(Object object, String property, float ....values)</code>的第二个参数传入值的作用是：让<code>ObjectAnimator</code>类根据传入的属性名 去寻找 该对象对应属性名的 <code>set（）&amp; get（）</code>方法，从而进行对象属性值的赋值.</p>
<p>  自动赋值的逻辑:</p>
<ul>
<li><p>初始化时，如果属性的初始值没有提供，则调用属性的 <code>get（）</code>进行取值,如果没有<code>get()</code>会崩溃掉</p>
</li>
<li><p>当<strong>值</strong>变化时，用对象该属性的 <code>set（）</code>方法，从而从而将新的属性值设置给对象属性。</p>
<p>对于属性动画，其拓展性在于：自定义对象的属性，并通过操作自定义的属性从而实现动画。</p>
<p>自定义属性的步骤：</p>
</li>
<li><p>为对象设置需要操作属性的set（） &amp; get（）方法</p>
</li>
<li><p>通过实现TypeEvaluator类从而定义属性变化的逻辑 </p>
<p>设置对象类属性的<code>set（）</code> &amp; <code>get（）</code>有两种方法：</p>
</li>
</ul>
<ol>
<li>通过继承原始类，直接给类加上该属性的 <code>get（）</code>&amp;  <code>set（）</code>,如上面的自定义<code>ObjectAnimation</code></li>
<li>通过包装原始动画对象，间接给对象加上该属性的 <code>get（）</code>&amp;<code>set（）</code>,如下面的例子</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 创建WrapperView类,用于包装View对象</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">WrapperView</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mTarget: View) &#123;<br>    <span class="hljs-keyword">var</span> width: <span class="hljs-built_in">Int</span><br>    	<span class="hljs-comment">// 设置set() &amp; get()方法</span><br>        <span class="hljs-keyword">get</span>() = mTarget.layoutParams.width<br>        <span class="hljs-keyword">set</span>(width) &#123;<br>            mTarget.layoutParams.width = width<br>            mTarget.requestLayout()<br>        &#125;<br>&#125;<br><br><span class="hljs-comment">// 得到包装类</span><br><span class="hljs-keyword">val</span> wrapper = WrapperView(textView)<br><span class="hljs-comment">// 直接操作包装类</span><br><span class="hljs-keyword">val</span> animator = ObjectAnimator.ofInt(wrapper, <span class="hljs-string">&quot;width&quot;</span>, <span class="hljs-number">500</span>)<br>animator.duration = <span class="hljs-number">1000</span><br>animator.start()<br></code></pre></td></tr></table></figure>

<p>  效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/IEWRNeXbdMpHjYx.gif" srcset="/img/loading.gif" lazyload alt="ObjectAnimator-改变set&get" style="zoom: 50%;" />



<h4 id="监听动画"><a href="#监听动画" class="headerlink" title="监听动画"></a>监听动画</h4><ul>
<li><code>Animation</code>类通过监听动画开始 &#x2F; 结束 &#x2F; 重复 &#x2F; 取消时刻来进行一系列操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AnimatorListener</span> &#123;<br>        <span class="hljs-comment">//开始时调用</span><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationStart</span><span class="hljs-params">(Animator animation)</span>;<br>        <span class="hljs-comment">//结束调用</span><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationEnd</span><span class="hljs-params">(Animator animation)</span>;<br>        <span class="hljs-comment">//取消时调用</span><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationCancel</span><span class="hljs-params">(Animator animation)</span>;<br>        <span class="hljs-comment">//重复时调用</span><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationRepeat</span><span class="hljs-params">(Animator animation)</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><strong>动画适配器AnimatorListenerAdapter</strong></p>
<p>  有时候我们并不需要监听动画的所有时刻,但<code>addListener(new AnimatorListener())</code>监听器是必须重写4个时刻方法，所以采用动画适配器（<code>AnimatorListenerAdapter</code>），只监听想要监听的时刻</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">animator.addListener(<span class="hljs-keyword">object</span> : AnimatorListenerAdapter() &#123;<br>            <span class="hljs-comment">// 向addListener()方法中传入适配器对象AnimatorListenerAdapter()</span><br>            <span class="hljs-comment">// 由于AnimatorListenerAdapter中已经实现好每个接口,所以这里不用全部实现</span><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAnimationStart</span><span class="hljs-params">(animation: <span class="hljs-type">Animator</span>)</span></span> &#123;<br>                <span class="hljs-comment">// 需要单独重写想要监听的方法就可以</span><br>            &#125;<br>        &#125;)<br></code></pre></td></tr></table></figure>

<h4 id="组合动画（AnimatorSet类）"><a href="#组合动画（AnimatorSet类）" class="headerlink" title="组合动画（AnimatorSet类）"></a>组合动画（AnimatorSet类）</h4><p>AnimatorSet提供了两个函数<code>playSequencially()</code>和<code>playTogether()</code></p>
<ul>
<li>playSequentially()表示所有动画依次播放</li>
<li>playTogether()表示所有动画一起播放</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java">	<span class="hljs-comment">//第一个函数是我们最常用的,传入多个Animator对象,这些动画会一起播放</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">playTogether</span><span class="hljs-params">(Animator... items)</span> &#123;<br>        <span class="hljs-keyword">if</span> (items != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> play(items[<span class="hljs-number">0</span>]);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; items.length; ++i) &#123;<br>                builder.with(items[i]);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">playTogether</span><span class="hljs-params">(Collection&lt;Animator&gt; items)</span> &#123;<br>        <span class="hljs-keyword">if</span> (items != <span class="hljs-literal">null</span> &amp;&amp; items.size() &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">for</span> (Animator anim : items) &#123;<br>                <span class="hljs-keyword">if</span> (builder == <span class="hljs-literal">null</span>) &#123;<br>                    builder = play(anim);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    builder.with(anim);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>  <br><span class="hljs-comment">//第一个函数是我们最常用的,传入多个Animator对象,这些动画会依次播放</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">playSequentially</span><span class="hljs-params">(Animator... items)</span> &#123;<br>        <span class="hljs-keyword">if</span> (items != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (items.length == <span class="hljs-number">1</span>) &#123;<br>                play(items[<span class="hljs-number">0</span>]);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; items.length - <span class="hljs-number">1</span>; ++i) &#123;<br>                    play(items[i]).before(items[i + <span class="hljs-number">1</span>]);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">playSequentially</span><span class="hljs-params">(List&lt;Animator&gt; items)</span> &#123;<br>        <span class="hljs-keyword">if</span> (items != <span class="hljs-literal">null</span> &amp;&amp; items.size() &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (items.size() == <span class="hljs-number">1</span>) &#123;<br>                play(items.get(<span class="hljs-number">0</span>));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; items.size() - <span class="hljs-number">1</span>; ++i) &#123;<br>                    play(items.get(i)).before(items.get(i + <span class="hljs-number">1</span>));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  下面看一下具体的使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">// playSequentially()依次播放</span><br> <span class="hljs-comment">// 设置需要组合的动画效果</span><br> <span class="hljs-type">val</span> <span class="hljs-variable">tvAnimator1</span> <span class="hljs-operator">=</span> ObjectAnimator.ofInt(<br>            textView, <span class="hljs-string">&quot;textColor&quot;</span>,<br>            <span class="hljs-number">0xffff00ff</span>.toInt(), <span class="hljs-number">0xffffff00</span>.toInt(), <span class="hljs-number">0xffff00ff</span>.toInt()<br>        )<br>        <span class="hljs-type">val</span> <span class="hljs-variable">tvAnimator2</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(textView, <span class="hljs-string">&quot;translationY&quot;</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">300f</span>, <span class="hljs-number">0f</span>)<br>        <span class="hljs-type">val</span> <span class="hljs-variable">tvAnimator3</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(textView, <span class="hljs-string">&quot;rotation&quot;</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">180f</span>, <span class="hljs-number">0f</span>)<br>        <span class="hljs-comment">// 创建组合动画的对象</span><br>        <span class="hljs-type">val</span> <span class="hljs-variable">animatorSet</span> <span class="hljs-operator">=</span> AnimatorSet()<br>        <span class="hljs-comment">// 根据需求组合动画</span><br>        animatorSet.playSequentially(tvAnimator1, tvAnimator2, tvAnimator3)<br>        animatorSet.duration = <span class="hljs-number">1000</span><br>        animatorSet.start()<br>        <br><span class="hljs-comment">//playTogether()一起播放</span><br><span class="hljs-type">val</span> <span class="hljs-variable">tvAnimator1</span> <span class="hljs-operator">=</span> ObjectAnimator.ofInt(<br>            textView, <span class="hljs-string">&quot;textColor&quot;</span>,<br>            <span class="hljs-number">0xffff00ff</span>.toInt(), <span class="hljs-number">0xffffff00</span>.toInt(), <span class="hljs-number">0xffff00ff</span>.toInt()<br>        )<br>        <span class="hljs-type">val</span> <span class="hljs-variable">tvAnimator2</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(textView, <span class="hljs-string">&quot;translationY&quot;</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">300f</span>, <span class="hljs-number">0f</span>)<br>        <span class="hljs-type">val</span> <span class="hljs-variable">tvAnimator3</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(textView, <span class="hljs-string">&quot;rotation&quot;</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">180f</span>, <span class="hljs-number">0f</span>)<br>        <span class="hljs-type">val</span> <span class="hljs-variable">animatorSet</span> <span class="hljs-operator">=</span> AnimatorSet()<br>        animatorSet.playTogether(tvAnimator1, tvAnimator2, tvAnimator3)<br>        animatorSet.duration = <span class="hljs-number">1000</span><br>        animatorSet.start()<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<table>
<thead>
<tr>
<th>PlayTogether</th>
<th>PlaySequentially</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/iGaWb2kcLHNBS6t.gif" srcset="/img/loading.gif" lazyload alt="PlayTogether" style="zoom: 33%;" /></td>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/jRHqCGsl7rmWnpN.gif" srcset="/img/loading.gif" lazyload alt="PlaySwquentially" style="zoom: 33%;" /></td>
</tr>
</tbody></table>
<p>  除了<code>playSequentally()</code>和<code>playTogether()</code>外,Animator还有Builder帮助我们控制动画的播放顺序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-comment">// 播放当前动画</span><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">play</span><span class="hljs-params">(Animator anim)</span> &#123;<br>    <span class="hljs-keyword">if</span> (anim != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Builder</span>(anim);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br>    <span class="hljs-comment">// 将现有动画延迟x毫秒后执行</span><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">with</span><span class="hljs-params">(Animator anim)</span> &#123;<br>        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> getNodeForAnimation(anim);<br>        mCurrentNode.addSibling(node);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 将现有动画插入到传入的动画之前执行</span><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">before</span><span class="hljs-params">(Animator anim)</span> &#123;<br>        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> getNodeForAnimation(anim);<br>        mCurrentNode.addChild(node);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//将现有动画插入到传入的动画之后执行</span><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">after</span><span class="hljs-params">(Animator anim)</span> &#123;<br>        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> getNodeForAnimation(anim);<br>        mCurrentNode.addParent(node);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 将现有动画延迟x毫秒后执行</span><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">after</span><span class="hljs-params">(<span class="hljs-type">long</span> delay)</span> &#123;<br>        <span class="hljs-comment">// setup a ValueAnimator just to run the clock</span><br>        <span class="hljs-type">ValueAnimator</span> <span class="hljs-variable">anim</span> <span class="hljs-operator">=</span> ValueAnimator.ofFloat(<span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>);<br>        anim.setDuration(delay);<br>        after(anim);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>AnimatorSet可以添加监听器,对应的监听器如下,和前面的监听器一样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AnimatorListener</span> &#123;<br>        <span class="hljs-comment">//开始时调用</span><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationStart</span><span class="hljs-params">(Animator animation)</span>;<br>        <span class="hljs-comment">//结束调用</span><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationEnd</span><span class="hljs-params">(Animator animation)</span>;<br>        <span class="hljs-comment">//取消时调用</span><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationCancel</span><span class="hljs-params">(Animator animation)</span>;<br>        <span class="hljs-comment">//重复时调用</span><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationRepeat</span><span class="hljs-params">(Animator animation)</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>注意:</p>
<ul>
<li>AnimatorSet的监听函数只是用来监听AnimatorSet的状态,与它里面的动画无关</li>
<li>AnimatorSet中没有设置循环的函数,所以动画执行一次就结束了,不会执行到onAnimationRepeat()中</li>
<li>在AnimatorSet中设置了动画时长和插值器,会覆盖原来单个ObjectAnimator的设置,但是<code>setStartDelay()</code>函数例外,它不会覆盖单个动画的延时</li>
</ul>
<h4 id="ViewPropertyAnimator"><a href="#ViewPropertyAnimator" class="headerlink" title="ViewPropertyAnimator"></a>ViewPropertyAnimator</h4><p>  属性动画对比原来的视图动画有很多的优点，属性动画可以对所有的对象做动画操作，但Android开发中需要做动画最多的还是View，如果只是对一个view做好几个属性动画，属性动画的写法是比较繁琐的。所以安卓3.1补充了ViewPropertyAnimator这个类,ViewPropertyAnimator专用于操作View动画，语法更加简洁，使用更加方便。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//将textView透明度变为0,并向x轴移动50,y轴移动100,使用起来非常简单        </span><br>textView.animate().alpha(<span class="hljs-number">0f</span>).x(<span class="hljs-number">50f</span>).y(<span class="hljs-number">100f</span>)<br></code></pre></td></tr></table></figure>

<p>注意:</p>
<ul>
<li><p><code>animate()</code>会返回一个ViewPropertyAnimator对象,可以通过调用这个对象的函数来设置需要实现动画的属性</p>
</li>
<li><p>自动开始:我们不需要显示的调用<code>start()</code>函数.</p>
</li>
<li><p>流畅(Fluent):ViewPropertyAnimator拥有一个流畅的接口(Fluent Interface),他允许将许多个函数调用自然地串在一起,并把一个多属性的动画写成一行代码</p>
<p>这是一些ViewPropertyAnimator常用的函数</p>
<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">alpha(float value)</td>
<td align="left">设置透明度</td>
</tr>
<tr>
<td align="left">alphaBy(float value)</td>
<td align="left">设置透明度增量</td>
</tr>
<tr>
<td align="left">rotation(float value)</td>
<td align="left">绕Z轴旋转</td>
</tr>
<tr>
<td align="left">rotationBy(float value)</td>
<td align="left">绕Z轴旋转增量</td>
</tr>
<tr>
<td align="left">rotationX(float value)</td>
<td align="left">绕X轴旋转</td>
</tr>
<tr>
<td align="left">rotationXBy(float value)</td>
<td align="left">绕X轴旋转增量</td>
</tr>
<tr>
<td align="left">rotationY(float value)</td>
<td align="left">绕Y轴旋转</td>
</tr>
<tr>
<td align="left">rotation</td>
<td align="left">绕Y轴旋转增量</td>
</tr>
<tr>
<td align="left">scaleX(float value)</td>
<td align="left">设置X轴方向的缩放大小</td>
</tr>
<tr>
<td align="left">scaleXBy(float value)</td>
<td align="left">设置X轴方向的缩放大小增量</td>
</tr>
<tr>
<td align="left">scaleY(float value)</td>
<td align="left">设置Y轴方向的缩放大小</td>
</tr>
<tr>
<td align="left">scaleYBy(float value)</td>
<td align="left">设置Y轴方向的缩放大小增量</td>
</tr>
<tr>
<td align="left">translationX(float value)</td>
<td align="left">沿X轴方向平移</td>
</tr>
<tr>
<td align="left">translationY(float value)</td>
<td align="left">沿Y轴方向平移</td>
</tr>
<tr>
<td align="left">translationYBy(float value)</td>
<td align="left">设置沿Y轴平移增量</td>
</tr>
<tr>
<td align="left">x(float value)</td>
<td align="left">相对于父容器左上角坐标在X轴方向的位置</td>
</tr>
<tr>
<td align="left">xBy(float value)</td>
<td align="left">相对于父容器左上角坐标在X轴方向的增量</td>
</tr>
<tr>
<td align="left">y(float value)</td>
<td align="left">相对于父容器左上角坐标在Y轴方向的位置</td>
</tr>
<tr>
<td align="left">yBy(float value)</td>
<td align="left">相对于父容器左上角坐标在Y轴方向的增量</td>
</tr>
<tr>
<td align="left">z(float value)</td>
<td align="left">相对于父容器左上角坐标在Z轴方向的位置</td>
</tr>
<tr>
<td align="left">zBy(float value)</td>
<td align="left">相对于父容器左上角坐标在Z轴方向的增量</td>
</tr>
</tbody></table>
</li>
</ul>
<h4 id="XML实现"><a href="#XML实现" class="headerlink" title="XML实现"></a>XML实现</h4><p>  属性动画一般是在代码中实现,如果需要复用的话可以写在xml中</p>
<p>  在res&#x2F;animator文件夹下，创建animator_translation.xml文件。XML文件有四个标签可用.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span>    <span class="hljs-comment">&lt;!--相当于AnimatorSet--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">animator</span> /&gt;</span>   <span class="hljs-comment">&lt;!--相当于ValueAnimator--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">objectAnimator</span>&gt;</span>     <span class="hljs-comment">&lt;!--相当于ObjectAnimator--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">propertyValuesHolder</span> /&gt;</span>  <span class="hljs-comment">&lt;!--相当于PropertyValuesHolder--&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">objectAnimator</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p><code>set</code>标签对应代码的<code>AnimatorSet</code>,只有一个属性可以设置：<code>android:ordering</code>，取值：同时播放<code>together</code>、顺序播放<code>sequentially</code>。</p>
<p><code>animator</code>标签对应代码的<code>ValueAnimator</code>，可以设置如下属性：</p>
<ul>
<li><code>android:propertyName</code>:属性名</li>
<li><code>android:duration</code>:动画时长</li>
<li><code>android:valueType</code>:属性类型,<code>intType</code>、<code>floatType</code>、<code>colorType</code>、<code>pathType</code></li>
<li><code>android:valueFrom</code>:属性初始值</li>
<li><code>android:valueTo</code>:属性结束值</li>
<li><code>android:repeatCount</code>:重复次数</li>
<li><code>android:repeatMode</code>:重复模式</li>
<li><code>android:interpolator</code>:插值器。</li>
<li><code>android:startOffset</code>:延迟，对应<code>startOffset()</code>延迟多少毫秒执行</li>
</ul>
<p><code>objectAnimator</code>属性对应代码<code>ObjectAnimator</code>,由于继承自<code>ValueAnimator</code>，所以属性相对多了<code>android:propertyName</code>。</p>
<p>示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">objectAnimator</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:propertyName</span>=<span class="hljs-string">&quot;ScaleX&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:duration</span>=<span class="hljs-string">&quot;1000&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:interpolator</span>=<span class="hljs-string">&quot;@android:interpolator/linear&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:repeatCount</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:repeatMode</span>=<span class="hljs-string">&quot;restart&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:startOffset</span>=<span class="hljs-string">&quot;100&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:valueFrom</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:valueTo</span>=<span class="hljs-string">&quot;2&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>



<h4 id="PropertyValuesHolder与KeyFrame"><a href="#PropertyValuesHolder与KeyFrame" class="headerlink" title="PropertyValuesHolder与KeyFrame"></a>PropertyValuesHolder与KeyFrame</h4><p>  PropertyValuesHolder这个类的意义就是，保存了动画过程中所需要操作的属性和对应的值。我们通过<code>ofFloat(Object target, String propertyName, float… values)</code>构造的动画，<code>ofFloat()</code>的内部实现其实就是将传进来的参数封装成 PropertyValuesHolder实例来保存动画状态。在封装成 PropertyValuesHolder实例以后，后期的各种操作也是以 PropertyValuesHolder 为主的。</p>
<p>创建PropertyValuesHolder实例的函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyValuesHolder <span class="hljs-title function_">ofFloat</span><span class="hljs-params">(String propertyName, <span class="hljs-type">float</span>... values)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyValuesHolder <span class="hljs-title function_">ofInt</span><span class="hljs-params">(String propertyName, <span class="hljs-type">int</span>... values)</span>   <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyValuesHolder <span class="hljs-title function_">ofObject</span><span class="hljs-params">(String propertyName, TypeEvaluator evaluator,Object... values)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyValuesHolder <span class="hljs-title function_">ofKeyframe</span><span class="hljs-params">(String propertyName, Keyframe... values)</span>  <br></code></pre></td></tr></table></figure>

<p>  可以看到在<code>ObjectAnimator.ofFloat</code>中只比<code>PropertyValuesHolder.ofFloat()</code>多了一个target.</p>
<p>将构造的PropertyValuesHolder实例设置进 ObjectAnimator：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ObjectAnimator <span class="hljs-title function_">ofPropertyValuesHolder</span><span class="hljs-params">(Object target,PropertyValuesHolder... values)</span><br></code></pre></td></tr></table></figure>

<p>PropertyValuesHolder 的<code>ofObject()</code>的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyValuesHolder <span class="hljs-title function_">ofObject</span><span class="hljs-params">(String propertyName, TypeEvaluator evaluator,Object... values)</span>  <br></code></pre></td></tr></table></figure>

<p><strong>Keyframe</strong></p>
<p>  KeyFrame主要用于自定义控制动画速率，KeyFrame直译过来就是关键帧。一个关键帧必须包含两个原素，第一时间点，第二位置。所以这个关键帧是表示的是某个物体在哪个时间点应该在哪个位置上。</p>
<p>  KeyFrame使用流程如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 生成 Keyframe 对象；</span><br>	<span class="hljs-keyword">val</span> frame0 = Keyframe.ofFloat(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>)<br>       <span class="hljs-keyword">val</span> frame1 = Keyframe.ofFloat(<span class="hljs-number">0.1f</span>, -<span class="hljs-number">45f</span>)<br>       <span class="hljs-keyword">val</span> frame2 = Keyframe.ofFloat(<span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>)<br><span class="hljs-comment">// 利用 PropertyValuesHolder.ofKeyframe()生成 PropertyValuesHolder 对象</span><br>       <span class="hljs-keyword">val</span> frameHolder = PropertyValuesHolder.ofKeyframe(<span class="hljs-string">&quot;rotation&quot;</span>, frame0, frame1, frame2)<br><span class="hljs-comment">// ObjectAnimator.ofPropertyValuesHolder()生成对应的 Animator</span><br>       <span class="hljs-keyword">val</span> animator: Animator = ObjectAnimator.ofPropertyValuesHolder(textView, frameHolder)<br>       animator.duration = <span class="hljs-number">1000</span><br>       animator.start()<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<p>注意：在设置<code>ObjectAnimator.ofPropertyValuesHolder()</code>时</p>
<ul>
<li>如果去掉第 0 帧<code>Keyframe.ofFloat(0f, 0)</code>，将以传入的第一个关键帧为起始位置</li>
<li>如果去掉结束帧<code>Keyframe.ofFloat(1f,0)</code>，将以传入最后一个关键帧为结束位置</li>
<li>使用 Keyframe 来构建动画，至少要有两个或两个以上帧。</li>
</ul>
<p>KeyFrame的一些常用方法(基本和前面一样)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// fraction：表示当前的显示进度, value：表示当前应该在的位置</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Keyframe <span class="hljs-title function_">ofFloat</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction, <span class="hljs-type">float</span> value)</span><br>	<span class="hljs-comment">// 表示动画进度为0时，动画所在的数值位置为0</span><br>	Keyframe.ofFloat(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>	<span class="hljs-comment">// 表示动画进度为 25%时，动画所在的数值位置为-20</span><br>	Keyframe.ofFloat(<span class="hljs-number">0.25f</span>, -<span class="hljs-number">20f</span>)；<br>	<span class="hljs-comment">// 表示动画结束时，动画所在的数值位置为0</span><br>	Keyframe.ofFloat(<span class="hljs-number">1f</span>,<span class="hljs-number">0</span>)；<br><span class="hljs-comment">// 设置fraction参数，即Keyframe所对应的进度</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFraction</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction)</span>	<br><span class="hljs-comment">// 设置当前Keyframe所对应的值</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object value)</span>	<br><span class="hljs-comment">// 设置Keyframe动作期间所对应的插值器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setInterpolator</span><span class="hljs-params">(TimeInterpolator interpolator)</span><br></code></pre></td></tr></table></figure>



<h3 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h3><h4 id="ValueAnimator源码解读"><a href="#ValueAnimator源码解读" class="headerlink" title="ValueAnimator源码解读"></a>ValueAnimator源码解读</h4><p>  讲完了使用,我们看看动画是怎么跑起来的,我们先分析<code>ValueAnimator</code>,<code>ObjectAnimator</code>是继承<code>ValueAnimator</code>,我们分析完<code>ValueAnimator</code>后再看看<code>ObjectAniamtor</code>多做了哪些工作</p>
<p>  先从<code>animator.start()</code>开始</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ValueAnimator</span><br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 调用内部的start,参数playBackwards是否反向播放,一般为false</span><br>        start(<span class="hljs-literal">false</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  进入内部的<code>start(boolean)</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ValueAnimator</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-type">boolean</span> playBackwards)</span> &#123;<br>        <span class="hljs-keyword">if</span> (Looper.myLooper() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidRuntimeException</span>(<span class="hljs-string">&quot;Animators may only be run on Looper threads&quot;</span>);<br>        &#125;<br>        mReversing = playBackwards;<br>        mSelfPulse = !mSuppressSelfPulseRequested;<br>        <span class="hljs-keyword">if</span> (playBackwards &amp;&amp; mSeekFraction != -<span class="hljs-number">1</span> &amp;&amp; mSeekFraction != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (mRepeatCount == INFINITE) &#123;<br>                <span class="hljs-comment">// Calculate the fraction of the current iteration.</span><br>                <span class="hljs-type">float</span> <span class="hljs-variable">fraction</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>) (mSeekFraction - Math.floor(mSeekFraction));<br>                mSeekFraction = <span class="hljs-number">1</span> - fraction;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                mSeekFraction = <span class="hljs-number">1</span> + mRepeatCount - mSeekFraction;<br>            &#125;<br>        &#125;<br>    <span class="hljs-comment">// 开始标志</span><br>        mStarted = <span class="hljs-literal">true</span>;<br>        mPaused = <span class="hljs-literal">false</span>;<br>        mRunning = <span class="hljs-literal">false</span>;<br>        mAnimationEndRequested = <span class="hljs-literal">false</span>;<br>        mLastFrameTime = -<span class="hljs-number">1</span>;<br>        mFirstFrameTime = -<span class="hljs-number">1</span>;<br>        mStartTime = -<span class="hljs-number">1</span>;<br>        <span class="hljs-comment">// 注册animation回调</span><br>        addAnimationCallback(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-keyword">if</span> (mStartDelay == <span class="hljs-number">0</span> || mSeekFraction &gt;= <span class="hljs-number">0</span> || mReversing) &#123;<br>            <span class="hljs-comment">// 开始动画</span><br>            startAnimation();<br>            <span class="hljs-keyword">if</span> (mSeekFraction == -<span class="hljs-number">1</span>) &#123;<br>                setCurrentPlayTime(<span class="hljs-number">0</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                setCurrentFraction(mSeekFraction);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  都是一些变量初始化,有两个方法<code>addAnimationCallback(0);</code>,<code>startAnimation()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ValueAnimator</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startAnimation</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (Trace.isTagEnabled(Trace.TRACE_TAG_VIEW)) &#123;<br>            Trace.asyncTraceBegin(Trace.TRACE_TAG_VIEW, getNameForTrace(),<br>                    System.identityHashCode(<span class="hljs-built_in">this</span>));<br>        &#125;<br><br>        mAnimationEndRequested = <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">// 进行一些初始化</span><br>        initAnimation();<br>        mRunning = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (mSeekFraction &gt;= <span class="hljs-number">0</span>) &#123;<br>            mOverallFraction = mSeekFraction;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            mOverallFraction = <span class="hljs-number">0f</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (mListeners != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 通知动画开始</span><br>            notifyStartListeners();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  里面调用了两个方法<code>initAnimation()</code>和<code>notifyStartListeners()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Java"> <span class="hljs-comment">// ValueAnimation</span><br> <span class="hljs-comment">// 一些初始化操作</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">initAnimation</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (!mInitialized) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">numValues</span> <span class="hljs-operator">=</span> mValues.length;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numValues; ++i) &#123;<br>                mValues[i].init();<br>            &#125;<br>            mInitialized = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyStartListeners</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (mListeners != <span class="hljs-literal">null</span> &amp;&amp; !mStartListenersCalled) &#123;<br>            ArrayList&lt;AnimatorListener&gt; tmpListeners =<br>                    (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">numListeners</span> <span class="hljs-operator">=</span> tmpListeners.size();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numListeners; ++i) &#123;<br>                <span class="hljs-comment">// 回调listener 接口</span><br>                tmpListeners.get(i).onAnimationStart(<span class="hljs-built_in">this</span>, mReversing);<br>            &#125;<br>        &#125;<br>        mStartListenersCalled = <span class="hljs-literal">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  都是一些初始化的操作,没有开始动画,我们回头看看<code>addAnimationCallback()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ValueAnimator</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAnimationCallback</span><span class="hljs-params">(<span class="hljs-type">long</span> delay)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!mSelfPulse) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// AnimationHandler 一个处理动画的类</span><br>        getAnimationHandler().addAnimationFrameCallback(<span class="hljs-built_in">this</span>, delay);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  看到这里调用了<code>AnimationHandler</code>,一个处理动画的单例类,并且把<code>this</code>传了进去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AnimationHandler</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAnimationFrameCallback</span><span class="hljs-params">(<span class="hljs-keyword">final</span> AnimationFrameCallback callback, <span class="hljs-type">long</span> delay)</span> &#123;<br>        <span class="hljs-comment">// mAnimationFrameCallback 是ArrayList列表,储存了AnimationFrameCallback 对象</span><br>        <span class="hljs-comment">// 当mAnimationFrameCallback=0时,第一次执行动画</span><br>        <span class="hljs-keyword">if</span> (mAnimationCallbacks.size() == <span class="hljs-number">0</span>) &#123;<br>            getProvider().postFrameCallback(mFrameCallback);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!mAnimationCallbacks.contains(callback)) &#123;<br>            mAnimationCallbacks.add(callback);<br>        &#125;<br>    <span class="hljs-comment">// delay是setStartDelay()设置的延迟执行</span><br>        <span class="hljs-keyword">if</span> (delay &gt; <span class="hljs-number">0</span>) &#123;<br>            mDelayedCallbackStartTime.put(callback, (SystemClock.uptimeMillis() + delay));<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>当<code>mAnimationFrameCallback=0</code>时</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AnimationHandler</span><br><span class="hljs-keyword">private</span> AnimationFrameCallbackProvider <span class="hljs-title function_">getProvider</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (mProvider == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 直接new一个</span><br>            mProvider = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyFrameCallbackProvider</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> mProvider;<br>    &#125;<br><br><span class="hljs-comment">// AnimationHandler MyFrameCallbackProvider</span><br><span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postFrameCallback</span><span class="hljs-params">(Choreographer.FrameCallback callback)</span> &#123;<br>            <span class="hljs-comment">// Choreographer 负责刷新注册监听以及提供回调接口供底层调用</span><br>            mChoreographer.postFrameCallback(callback);<br>        &#125;<br><br><br><span class="hljs-comment">// Choreographer</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postFrameCallback</span><span class="hljs-params">(FrameCallback callback)</span> &#123;<br>        postFrameCallbackDelayed(callback, <span class="hljs-number">0</span>);<br>    &#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postFrameCallbackDelayed</span><span class="hljs-params">(FrameCallback callback, <span class="hljs-type">long</span> delayMillis)</span> &#123;<br>        <span class="hljs-keyword">if</span> (callback == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;callback must not be null&quot;</span>);<br>        &#125;<br>    <span class="hljs-comment">// 内部调用了 postCallbackDelayedInternal()</span><br>        postCallbackDelayedInternal(CALLBACK_ANIMATION,<br>                callback, FRAME_CALLBACK_TOKEN, delayMillis);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  <code>Choreographer</code>内部有几个队列，上面方法的第一个参数 <code>CALLBACK_ANIMATION</code>就是用于区分这些队列的，而每个队列里可以存放 <code>FrameCallback</code>对象，也可以存放 Runnable 对象。Animation 动画原理上就是通过 ViewRootImpl 生成一个 <code>doTraversal()</code> 的 Runnable 对象（其实也就是遍历 View 树的工作）存放到 Choreographer 的队列里的。而这些队列里的工作，都是用于在接收到屏幕刷新信号时取出来执行的。但有一个关键点，Choreographer 要能够接收到屏幕刷新信号的事件，是需要先调用 Choreographer 的 <code>scheduleVsyncLocked()</code> 方法来向底层注册监听下一个屏幕刷新信号事件的。  </p>
<p>  **小结:**当<code>ValueAnimator</code>调用了<code>start()</code>方法之后，首先会对一些变量进行初始化工作并通知动画开始了，然后<code>ValueAnimator</code>实现了 <code>AnimationFrameCallback</code>接口，并通过<code>AnimationHander</code>将自身 this 作为参数传到<code>mAnimationCallbacks</code>列表里缓存起来。而<code>AnimationHandler</code>在<code>mAnimationCallbacks</code>列表大小为 0 时会通过内部类<code>MyFrameCallbackProvider</code>将一个<code>mFrameCallback</code>工作缓存到<code>Choreographer</code>的待执行队列里，并向底层注册监听下一个屏幕刷新信号事件。</p>
<p>  当接收到屏幕刷新信号之后，mFrameCallback 又继续做了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AnimationHandler</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Choreographer.<span class="hljs-type">FrameCallback</span> <span class="hljs-variable">mFrameCallback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Choreographer</span>.FrameCallback() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFrame</span><span class="hljs-params">(<span class="hljs-type">long</span> frameTimeNanos)</span> &#123;<br>            <span class="hljs-comment">// 处理动画相关工作</span><br>            doAnimationFrame(getProvider().getFrameTime());<br>            <span class="hljs-keyword">if</span> (mAnimationCallbacks.size() &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 继续向底层注册下一个屏幕刷新事件,因为动画是持续的过程,每一帧都会处理一个动画进度,需要在动画结束前注册监听下一个信号事件</span><br>                getProvider().postFrameCallback(<span class="hljs-built_in">this</span>);<br>            &#125;<br>        &#125;<br>    &#125;;<br></code></pre></td></tr></table></figure>

<p>  当第一个属性动画调用了 <code>start()</code> 时，由于 mAnimationCallbacks 列表此时大小为 0，所以直接由 <code>addAnimationFrameCallback()</code> 方法内部间接的向底层注册下一个屏幕刷新信号事件，然后将该动画加入到列表里。而当接收到屏幕刷新信号时，mFrameCallback 的 <code>doFrame()</code> 会被回调，该方法内部做了两件事，一是去处理当前帧的动画，二则是根据列表的大小是否不为 0 来决定继续向底层注册监听下一个屏幕刷新信号事件，如此反复，直至列表大小为 0。</p>
<p>  接下来跟着<code>doAnimationFrame()</code>看看属性动画是怎么执行的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AnimationHandler</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAnimationFrame</span><span class="hljs-params">(<span class="hljs-type">long</span> frameTime)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> SystemClock.uptimeMillis();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> mAnimationCallbacks.size();<br>    <span class="hljs-comment">// 循环遍历列表,取出每一个ValueAnimator</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++) &#123;<br>            <span class="hljs-comment">// ValueAnimator实现了AnimationFrameCallback接口,并且在调用Start()方法后通过AnimationHandler将this缓存到这个列表里</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">AnimationFrameCallback</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> mAnimationCallbacks.get(i);<br>            <span class="hljs-keyword">if</span> (callback == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-comment">// 判断是否到了执行时间</span><br>            <span class="hljs-keyword">if</span> (isCallbackDue(callback, currentTime)) &#123;<br>                <span class="hljs-comment">// 处理动画逻辑</span><br>                callback.doAnimationFrame(frameTime);<br>                <span class="hljs-keyword">if</span> (mCommitCallbacks.contains(callback)) &#123;<br>                    getProvider().postCommitCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                            commitAnimationFrame(callback, getProvider().getFrameTime());<br>                        &#125;<br>                    &#125;);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 处理已经结束的动画,清理列表</span><br>        cleanUpList();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>我们先看看<code>cleanUpList()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AnimationHandler</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanUpList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (mListDirty) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> mAnimationCallbacks.size() - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>                <span class="hljs-comment">// 就是把null的对象移除掉</span><br>                <span class="hljs-keyword">if</span> (mAnimationCallbacks.get(i) == <span class="hljs-literal">null</span>) &#123;<br>                    mAnimationCallbacks.remove(i);<br>                &#125;<br>            &#125;<br>            mListDirty = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  再看看处理动画逻辑<code>doAnimationFrame()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ValueAnimator </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">doAnimationFrame</span><span class="hljs-params">(<span class="hljs-type">long</span> frameTime)</span> &#123;<br>        <span class="hljs-keyword">if</span> (mStartTime &lt; <span class="hljs-number">0</span>) &#123;<br>            mStartTime = mReversing<br>                    ? frameTime<br>                    : frameTime + (<span class="hljs-type">long</span>) (mStartDelay * resolveDurationScale());<br>        &#125;<br><br>        <span class="hljs-comment">// Handle pause/resume</span><br>        <span class="hljs-keyword">if</span> (mPaused) &#123;<br>            mPauseTime = frameTime;<br>            removeAnimationCallback();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mResumed) &#123;<br>            mResumed = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (mPauseTime &gt; <span class="hljs-number">0</span>) &#123;<br>                mStartTime += (frameTime - mPauseTime);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!mRunning) &#123;<br>            <span class="hljs-keyword">if</span> (mStartTime &gt; frameTime &amp;&amp; mSeekFraction == -<span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                mRunning = <span class="hljs-literal">true</span>;<br>                startAnimation();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (mLastFrameTime &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// mSeekFraction从某个位置开始</span><br>            <span class="hljs-keyword">if</span> (mSeekFraction &gt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">seekTime</span> <span class="hljs-operator">=</span> (<span class="hljs-type">long</span>) (getScaledDuration() * mSeekFraction);<br>                <span class="hljs-comment">// mStartTime 第一帧的时间戳</span><br>                mStartTime = frameTime - seekTime;<br>                mSeekFraction = -<span class="hljs-number">1</span>;<br>            &#125;<br>            mStartTimeCommitted = <span class="hljs-literal">false</span>; <span class="hljs-comment">// allow start time to be compensated for jank</span><br>        &#125;<br>        mLastFrameTime = frameTime;<br> <br>        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> Math.max(frameTime, mStartTime);<br>        <span class="hljs-comment">// 根据当前时间计算帧的动画进度(核心)</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> animateBasedOnTime(currentTime);<br><br>        <span class="hljs-keyword">if</span> (finished) &#123;<br>            <span class="hljs-comment">// 将当前动画从mAniamtionCallbacks 中移除</span><br>            endAnimation();<br>        &#125;<br>        <span class="hljs-keyword">return</span> finished;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  先分析<code>endAnimation()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ValueAnimator</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">endAnimation</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (mAnimationEndRequested) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 调用AniamtionHandler 的removeCallback()</span><br>        removeAnimationCallback();<br><br>        mAnimationEndRequested = <span class="hljs-literal">true</span>;<br>        mPaused = <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">notify</span> <span class="hljs-operator">=</span> (mStarted || mRunning) &amp;&amp; mListeners != <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (notify &amp;&amp; !mRunning) &#123;<br>            notifyStartListeners();<br>        &#125;<br>        mRunning = <span class="hljs-literal">false</span>;<br>        mStarted = <span class="hljs-literal">false</span>;<br>        mStartListenersCalled = <span class="hljs-literal">false</span>;<br>        mLastFrameTime = -<span class="hljs-number">1</span>;<br>        mFirstFrameTime = -<span class="hljs-number">1</span>;<br>        mStartTime = -<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (notify &amp;&amp; mListeners != <span class="hljs-literal">null</span>) &#123;<br>            ArrayList&lt;AnimatorListener&gt; tmpListeners =<br>                    (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">numListeners</span> <span class="hljs-operator">=</span> tmpListeners.size();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numListeners; ++i) &#123;<br>                <span class="hljs-comment">// 通知动画结束</span><br>                tmpListeners.get(i).onAnimationEnd(<span class="hljs-built_in">this</span>, mReversing);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// mReversing needs to be reset *after* notifying the listeners for the end callbacks.</span><br>        mReversing = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (Trace.isTagEnabled(Trace.TRACE_TAG_VIEW)) &#123;<br>            Trace.asyncTraceEnd(Trace.TRACE_TAG_VIEW, getNameForTrace(),<br>                    System.identityHashCode(<span class="hljs-built_in">this</span>));<br>        &#125;<br>    &#125;<br><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeAnimationCallback</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (!mSelfPulse) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        getAnimationHandler().removeCallback(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br><span class="hljs-comment">// AnimarionHandler</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeCallback</span><span class="hljs-params">(AnimationFrameCallback callback)</span> &#123;<br>        mCommitCallbacks.remove(callback);<br>        mDelayedCallbackStartTime.remove(callback);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> mAnimationCallbacks.indexOf(callback);<br>        <span class="hljs-keyword">if</span> (id &gt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 把结束的动画赋值为空</span><br>            mAnimationCallbacks.set(id, <span class="hljs-literal">null</span>);<br>            mListDirty = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  如果动画结束，那么它会将其自身在 AnimationCallbacks 列表里的引用赋值为 null，然后移出列表的工作就交由 AnimationHandler 去做。</p>
<p>  接下来看看处理动画第一帧的工作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">if</span> (mStartTime &lt; <span class="hljs-number">0</span>) &#123;<br>            mStartTime = mReversing<br>                    ? frameTime<br>                    : frameTime + (<span class="hljs-type">long</span>) (mStartDelay * resolveDurationScale());<br>        &#125;<br><span class="hljs-keyword">if</span> (mLastFrameTime &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// mSeekFraction从某个位置开始</span><br>            <span class="hljs-keyword">if</span> (mSeekFraction &gt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">seekTime</span> <span class="hljs-operator">=</span> (<span class="hljs-type">long</span>) (getScaledDuration() * mSeekFraction);<br>                <span class="hljs-comment">// mStartTime 第一帧的时间戳</span><br>                mStartTime = frameTime - seekTime;<br>                mSeekFraction = -<span class="hljs-number">1</span>;<br>            &#125;<br>            mStartTimeCommitted = <span class="hljs-literal">false</span>; <span class="hljs-comment">// allow start time to be compensated for jank</span><br>        &#125;<br></code></pre></td></tr></table></figure>

<p>  记录动画第一帧的时间了，mStartTime 变量就是表示第一帧的时间戳， mSeekFraction 变量，可以任意选择从某个进度开始播放。可以通过 <code>setCurrentPlayTime()</code>设置。</p>
<p>小结:</p>
<ul>
<li><p>ValueAnimator 属性动画调用了 start() 之后，会先去进行一些初始化工作，包括变量的初始化、通知动画开始事件；</p>
</li>
<li><p>然后通过 AnimationHandler 将其自身 this 添加到 mAnimationCallbacks 队列里，AnimationHandller 是一个单例类，为所有的属性动画服务，列表里存放着所有正在进行或准备开始的属性动画；</p>
</li>
<li><p>如果当前存在要运行的动画，那么 AnimationHandler 会去通过 Choreographer 向底层注册监听下一个屏幕刷新信号，当接收到信号时，它的 mFrameCallback 会开始进行工作，工作的内容包括遍历列表来分别处理每个属性动画在当前帧的行为，处理完列表中的所有动画后，如果列表还不为 0，那么它又会通过 Choreographer 再去向底层注册监听下一个屏幕刷新信号事件，如此反复，直至所有的动画都结束。</p>
</li>
<li><p>AnimationHandler 遍历列表处理动画是在 doAnimationFrame() 中进行，而具体每个动画的处理逻辑则是在各自 ValueAnimator 的 doAnimationFrame() 中进行，各个动画如果处理完自身的工作后发现动画已经结束了，那么会将其在列表中的引用赋值为空，AnimationHandler 最后会去将列表中所有为 null 的都移除掉，来清理资源。</p>
</li>
<li><p>每个动画 ValueAnimator 在处理自身的动画行为时，首先，如果当前是动画的第一帧，那么会根据是否有”跳过片头”（setCurrentPlayTime()）来记录当前动画第一帧的时间 mStartTime 应该是什么。</p>
<p>接下来分析<code>animateBasedOnTime()</code>,根据当前时间计算并实现当前帧的动画工作.</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ValueAnimator</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">animateBasedOnTime</span><span class="hljs-params">(<span class="hljs-type">long</span> currentTime)</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">done</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (mRunning) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">scaledDuration</span> <span class="hljs-operator">=</span> getScaledDuration();<br>            <span class="hljs-comment">// 根据当前时间以及动画第一帧时间和动画持续时长来计算当前进度</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">fraction</span> <span class="hljs-operator">=</span> scaledDuration &gt; <span class="hljs-number">0</span> ?<br>                    (<span class="hljs-type">float</span>)(currentTime - mStartTime) / scaledDuration : <span class="hljs-number">1f</span>;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">lastFraction</span> <span class="hljs-operator">=</span> mOverallFraction;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">newIteration</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) fraction &gt; (<span class="hljs-type">int</span>) lastFraction;<br>            <span class="hljs-comment">// 根据mRepeatCount处理动画是否重新开始</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">lastIterationFinished</span> <span class="hljs-operator">=</span> (fraction &gt;= mRepeatCount + <span class="hljs-number">1</span>) &amp;&amp;<br>                    (mRepeatCount != INFINITE);<br>            <span class="hljs-keyword">if</span> (scaledDuration == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 0 duration animator, ignore the repeat count and skip to the end</span><br>                done = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newIteration &amp;&amp; !lastIterationFinished) &#123;<br>                <span class="hljs-comment">// Time to repeat</span><br>                <span class="hljs-keyword">if</span> (mListeners != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">numListeners</span> <span class="hljs-operator">=</span> mListeners.size();<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numListeners; ++i) &#123;<br>                        mListeners.get(i).onAnimationRepeat(<span class="hljs-built_in">this</span>);<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lastIterationFinished) &#123;<br>                done = <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-comment">// 确保动画进度取值在0-1之间,(因为属性动画有setRepeatCount()方法,会导致进度超过1.</span><br>            mOverallFraction = clampFraction(fraction);<br>            <span class="hljs-type">float</span> <span class="hljs-variable">currentIterationFraction</span> <span class="hljs-operator">=</span> getCurrentIterationFraction(<br>                    mOverallFraction, mReversing);<br>            <span class="hljs-comment">// 应用动画</span><br>            animateValue(currentIterationFraction);<br>        &#125;<br>        <span class="hljs-keyword">return</span> done;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>进入<code>animateValue()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ValueAnimator</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">animateValue</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction)</span> &#123;<br>        <span class="hljs-comment">// 根据插值器计算当前真正的动画进度</span><br>        fraction = mInterpolator.getInterpolation(fraction);<br>        mCurrentFraction = fraction;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numValues</span> <span class="hljs-operator">=</span> mValues.length;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numValues; ++i) &#123;<br>            <span class="hljs-comment">// 根据动画进度计算出实际的数值</span><br>            <span class="hljs-comment">// mValues 是 PropertyValuesHolder 类型数组</span><br>            mValues[i].calculateValue(fraction);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (mUpdateListeners != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">numListeners</span> <span class="hljs-operator">=</span> mUpdateListeners.size();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numListeners; ++i) &#123;<br>                <span class="hljs-comment">// 通知动画进度的回调</span><br>                mUpdateListeners.get(i).onAnimationUpdate(<span class="hljs-built_in">this</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  <code>PropertyValuesHolder</code>就是一个存放属性和值的容器,而每次动画的过程中都会从这个容器中取值或者设置值  </p>
<p>看看<code>calculateValue()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">// PropertyValuesHolder</span><br> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateValue</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction)</span> &#123;<br>        <span class="hljs-comment">// 通过KeyFrames计算</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> mKeyframes.getValue(fraction);<br>        mAnimatedValue = mConverter == <span class="hljs-literal">null</span> ? value : mConverter.convert(value);<br>    &#125;<br><br><span class="hljs-comment">// KeyFrames 是一个接口,找一下他的实现类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Keyframes</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cloneable</span> &#123;<br>    Object <span class="hljs-title function_">getValue</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction)</span>;<br>&#125;<br><br><span class="hljs-comment">// PropertyValuesHolder</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFloatValues</span><span class="hljs-params">(<span class="hljs-type">float</span>... values)</span> &#123;<br>        mValueType = <span class="hljs-type">float</span>.class;<br>        mKeyframes = KeyframeSet.ofFloat(values);<br>    &#125;<br></code></pre></td></tr></table></figure>



<p>其实 <code>ValueAnimator.ofInt()</code> 内部会根据相应的方法来创建 mKeyframes 对象，也就是说，在实例化属性动画时，这些 mKeyframes 也顺便被实例化了。</p>
<p><a name="KeyframeSet的ofInt()"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// KeyframeSet</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> KeyframeSet <span class="hljs-title function_">ofInt</span><span class="hljs-params">(<span class="hljs-type">int</span>... values)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numKeyframes</span> <span class="hljs-operator">=</span> values.length;<br>        IntKeyframe keyframes[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntKeyframe</span>[Math.max(numKeyframes,<span class="hljs-number">2</span>)];<br>        <span class="hljs-keyword">if</span> (numKeyframes == <span class="hljs-number">1</span>) &#123;<br>            keyframes[<span class="hljs-number">0</span>] = (IntKeyframe) Keyframe.ofInt(<span class="hljs-number">0f</span>);<br>            keyframes[<span class="hljs-number">1</span>] = (IntKeyframe) Keyframe.ofInt(<span class="hljs-number">1f</span>, values[<span class="hljs-number">0</span>]);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            keyframes[<span class="hljs-number">0</span>] = (IntKeyframe) Keyframe.ofInt(<span class="hljs-number">0f</span>, values[<span class="hljs-number">0</span>]);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; numKeyframes; ++i) &#123;<br>                <span class="hljs-comment">// 创建关键帧时,第一个参数是关键帧在整个区间之间的位置,第二个参数就是它的值是多少</span><br>                keyframes[i] =<br>                        (IntKeyframe) Keyframe.ofInt((<span class="hljs-type">float</span>) i / (numKeyframes - <span class="hljs-number">1</span>), values[i]);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 创建了IntKeyframeSet 对象</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntKeyframeSet</span>(keyframes);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  动画在处理当前帧的工作时，会去计算当前帧的动画进度，然后根据这个 0-1 区间的进度，映射到我们需要的数值，而这个映射之后的数值就是通过 mKeyframes 的 <code>getValue()</code> 里取到的，mKeyframes 是一个 KeyframeSet 对象，在创建属性动画时也顺带被创建了，而创建属性动画时，我们会传入一个我们想要的数值，如 <code>ValueAnimator.ofInt(100)</code> 就表示我们想要的动画变化范围是 0-100，那么这个 100 在内部也会被传给 <code>KeyframeSet.ofInt(100)</code>，然后就是进入到上面代码块里的创建工作了。</p>
<p>  <code>KeyframeSet.ofInt()</code> 最后是创建了一个 IntKeyframeSet 对象,我们看看这个类的<code>getValue()</code>是怎么实现的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// IntKeyframeSet</span><br> <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction)</span> &#123;<br>        <span class="hljs-keyword">return</span> getIntValue(fraction);<br>    &#125;<br><br><br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getIntValue</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction)</span> &#123;<br>        <span class="hljs-comment">// 处理第一帧</span><br>        <span class="hljs-keyword">if</span> (fraction &lt;= <span class="hljs-number">0f</span>) &#123;<br>            <span class="hljs-comment">// 获取第一帧和第二帧</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">IntKeyframe</span> <span class="hljs-variable">prevKeyframe</span> <span class="hljs-operator">=</span> (IntKeyframe) mKeyframes.get(<span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">IntKeyframe</span> <span class="hljs-variable">nextKeyframe</span> <span class="hljs-operator">=</span> (IntKeyframe) mKeyframes.get(<span class="hljs-number">1</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">prevValue</span> <span class="hljs-operator">=</span> prevKeyframe.getIntValue();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">nextValue</span> <span class="hljs-operator">=</span> nextKeyframe.getIntValue();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">prevFraction</span> <span class="hljs-operator">=</span> prevKeyframe.getFraction();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">nextFraction</span> <span class="hljs-operator">=</span> nextKeyframe.getFraction();<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">TimeInterpolator</span> <span class="hljs-variable">interpolator</span> <span class="hljs-operator">=</span> nextKeyframe.getInterpolator();<br>            <span class="hljs-keyword">if</span> (interpolator != <span class="hljs-literal">null</span>) &#123;<br>                fraction = interpolator.getInterpolation(fraction);<br>            &#125;<br>            <span class="hljs-comment">// 将动画进度转换成第一帧和第二帧之间的进度</span><br>            <span class="hljs-type">float</span> <span class="hljs-variable">intervalFraction</span> <span class="hljs-operator">=</span> (fraction - prevFraction) / (nextFraction - prevFraction);<br>            <span class="hljs-keyword">return</span> mEvaluator == <span class="hljs-literal">null</span> ?<br>                    prevValue + (<span class="hljs-type">int</span>)(intervalFraction * (nextValue - prevValue)) :<br>                    ((Number)mEvaluator.evaluate(intervalFraction, prevValue, nextValue)).<br>                            intValue();<br>        &#125;<br>        <span class="hljs-comment">// 处理最后一帧</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fraction &gt;= <span class="hljs-number">1f</span>) &#123;<br>            <span class="hljs-comment">// 取出倒数第一帧跟倒数第二帧的信息</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">IntKeyframe</span> <span class="hljs-variable">prevKeyframe</span> <span class="hljs-operator">=</span> (IntKeyframe) mKeyframes.get(mNumKeyframes - <span class="hljs-number">2</span>);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">IntKeyframe</span> <span class="hljs-variable">nextKeyframe</span> <span class="hljs-operator">=</span> (IntKeyframe) mKeyframes.get(mNumKeyframes - <span class="hljs-number">1</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">prevValue</span> <span class="hljs-operator">=</span> prevKeyframe.getIntValue();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">nextValue</span> <span class="hljs-operator">=</span> nextKeyframe.getIntValue();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">prevFraction</span> <span class="hljs-operator">=</span> prevKeyframe.getFraction();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">nextFraction</span> <span class="hljs-operator">=</span> nextKeyframe.getFraction();<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">TimeInterpolator</span> <span class="hljs-variable">interpolator</span> <span class="hljs-operator">=</span> nextKeyframe.getInterpolator();<br>            <span class="hljs-keyword">if</span> (interpolator != <span class="hljs-literal">null</span>) &#123;<br>                fraction = interpolator.getInterpolation(fraction);<br>            &#125;<br>            <span class="hljs-comment">// 将进度换算到这两针之间的进度</span><br>            <span class="hljs-type">float</span> <span class="hljs-variable">intervalFraction</span> <span class="hljs-operator">=</span> (fraction - prevFraction) / (nextFraction - prevFraction);<br>            <span class="hljs-keyword">return</span> mEvaluator == <span class="hljs-literal">null</span> ?<br>                    prevValue + (<span class="hljs-type">int</span>)(intervalFraction * (nextValue - prevValue)) :<br>                    ((Number)mEvaluator.evaluate(intervalFraction, prevValue, nextValue)).intValue();<br>        &#125;<br>        <span class="hljs-comment">// 处理中间帧</span><br>        <span class="hljs-type">IntKeyframe</span> <span class="hljs-variable">prevKeyframe</span> <span class="hljs-operator">=</span> (IntKeyframe) mKeyframes.get(<span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// 遍历每一帧,判断当前的动画进度和这一帧的位置</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; mNumKeyframes; ++i) &#123;<br>            <span class="hljs-type">IntKeyframe</span> <span class="hljs-variable">nextKeyframe</span> <span class="hljs-operator">=</span> (IntKeyframe) mKeyframes.get(i);<br>            <span class="hljs-keyword">if</span> (fraction &lt; nextKeyframe.getFraction()) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">TimeInterpolator</span> <span class="hljs-variable">interpolator</span> <span class="hljs-operator">=</span> nextKeyframe.getInterpolator();<br>                <span class="hljs-type">float</span> <span class="hljs-variable">intervalFraction</span> <span class="hljs-operator">=</span> (fraction - prevKeyframe.getFraction()) /<br>                    (nextKeyframe.getFraction() - prevKeyframe.getFraction());<br>                <span class="hljs-type">int</span> <span class="hljs-variable">prevValue</span> <span class="hljs-operator">=</span> prevKeyframe.getIntValue();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">nextValue</span> <span class="hljs-operator">=</span> nextKeyframe.getIntValue();<br>                <span class="hljs-comment">// Apply interpolator on the proportional duration.</span><br>                <span class="hljs-keyword">if</span> (interpolator != <span class="hljs-literal">null</span>) &#123;<br>                    intervalFraction = interpolator.getInterpolation(intervalFraction);<br>                &#125;<br>                <span class="hljs-keyword">return</span> mEvaluator == <span class="hljs-literal">null</span> ?<br>                        prevValue + (<span class="hljs-type">int</span>)(intervalFraction * (nextValue - prevValue)) :<br>                        ((Number)mEvaluator.evaluate(intervalFraction, prevValue, nextValue)).<br>                                intValue();<br>            &#125;<br>            prevKeyframe = nextKeyframe;<br>        &#125;<br>        <span class="hljs-comment">// shouldn&#x27;t get here</span><br>        <span class="hljs-keyword">return</span> ((Number)mKeyframes.get(mNumKeyframes - <span class="hljs-number">1</span>).getValue()).intValue();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  当关键帧只有两帧时，比如 <code>ValueAnimator.ofInt(100)</code>， 内部其实就是只创建了两个关键帧，一个是起点 0，一个是结束点 100。那么，在这种只有两帧的情况下，将 0-1 的动画进度值转换成我们需要的 0-100 区间内的值，系统的处理很简单，如果没有设置估值器，那么就直接是按比例来转换，比如进度为 0.5，那按比例转换就是 (100 - 0) * 0.5 &#x3D; 50。</p>
<p>  在处理第一帧的工作时，只需要将第二帧当成是最后一帧，那么第一帧和第二帧这样也就可以看成是只有两帧的场景了吧。但是参数 fraction 动画进度是以实际第一帧到最后一帧计算出来的，所以需要先对它进行转换，换算出它在第一帧到第二帧之间的进度，接下去的逻辑也就跟处理两帧时的逻辑是一样的了。同理, 在处理最后一帧时，只需要取出倒数第一帧跟倒数第二帧的信息，然后将进度换算到这两针之间的进度。</p>
<p>  处理中间帧比较复杂,系统从第一帧开始，按顺序遍历每一帧，然后去判断当前的动画进度跟这一帧保存的位置信息来找出当前进度是否就是落在某两个关键帧之间。然后按照两帧的情况处理</p>
<p>  小结:</p>
<ul>
<li>当接收到屏幕刷新信号后，AnimationHandler 会去遍历列表，将所有待执行的属性动画都取出来去计算当前帧的动画行为。</li>
<li>每个动画在处理当前帧的动画逻辑时，首先会先根据当前时间和动画第一帧时间以及动画的持续时长来初步计算出当前帧时动画所处的进度，然后会将这个进度值等价转换到 0-1 区间之内。</li>
<li>接着，插值器会将这个经过初步计算之后的进度值根据设定的规则计算出实际的动画进度值，取值也是在 0-1 区间内。</li>
<li>计算出当前帧动画的实际进度之后，会将这个进度值交给关键帧机制，来换算出我们需要的值，比如 ValueAnimator.ofInt(0, 100) 表示我们需要的值变化范围是从 0-100，那么插值器计算出的进度值是 0-1 之间的，接下去就需要借助关键帧机制来映射到 0-100 之间。</li>
<li>关键帧的数量是由 ValueAnimator.ofInt(0, 1, 2, 3) 参数的数量来决定的，比如这个就有四个关键帧，第一帧和最后一帧是必须的，所以最少会有两个关键帧，如果参数只有一个，那么第一帧默认为 0，最后一帧就是参数的值。当调用了这个 ofInt() 方法时，关键帧组也就被创建了。</li>
<li>当只有两个关键帧时，映射的规则是，如果没有设置估值器，那么就等比例映射，比如动画进度为 0.5，需要的值变化区间是 0-100，那么等比例映射后的值就是 50，那么我们在 onAnimationUpdate 的回调中通过 animation.getAnimatedValue() 获取到的值 50 就是这么来的。</li>
<li>当关键帧超过两个时，需要先找到当前动画进度是落于哪两个关键帧之间，然后将这个进度值先映射到这两个关键帧之间的取值，接着就可以将这两个关键帧看成是第一帧和最后一帧，那么就可以按照只有两个关键帧的情况下的映射规则来进行计算了。</li>
<li>而进度值映射到两个关键帧之间的取值，这就需要知道每个关键帧在整个关键帧组中的位置信息，或者说权重。而这个位置信息是在创建每个关键帧时就传进来的。onInt() 的规则是所有关键帧按等比例来分配权重。</li>
</ul>
<p>到这里我们就分析完<code>ValueAnimator</code>了</p>
<p>我们再来看一下ValueAnimator的时序图</p>
<p><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/A6eql3FxIhgyS8H.png" srcset="/img/loading.gif" lazyload alt="ValueAnimator原理时序图"></p>
<p><a target="_blank" rel="noopener" href="https://www.processon.com/view/link/62e1d8d6f346fb0760d091d5">ValueAnimation时序图 -查看大图</a></p>
<h4 id="ObjectAnimator源码解读"><a href="#ObjectAnimator源码解读" class="headerlink" title="ObjectAnimator源码解读"></a>ObjectAnimator源码解读</h4><p>  我们先从<code>ObjectAnimator.ofInt()</code>开始</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ObjectAnimator</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ObjectAnimator <span class="hljs-title function_">ofInt</span><span class="hljs-params">(Object target, String propertyName, <span class="hljs-type">int</span>... values)</span> &#123;<br>        <span class="hljs-comment">// 创建ObjectAnimator对象,设置属性动画的目标target和作用于target的属性名propertyName</span><br>        <span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">anim</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectAnimator</span>(target, propertyName);<br>        anim.setIntValues(values);<br>        <span class="hljs-keyword">return</span> anim;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  看一下<code>ObjectAnimator</code>的构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ObjectAnimator</span><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">ObjectAnimator</span><span class="hljs-params">(Object target, String propertyName)</span> &#123;<br>        <span class="hljs-comment">// 设置目标View</span><br>        setTarget(target);<br>        <span class="hljs-comment">// 设置属性名称</span><br>        setPropertyName(propertyName);<br>    &#125;<br><br><br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTarget</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object target)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">oldTarget</span> <span class="hljs-operator">=</span> getTarget();<br>        <span class="hljs-comment">// 当oldTarget不等于target，且已经调用了start()方法使得mStarted标志位为true时,先取消掉动画</span><br>        <span class="hljs-keyword">if</span> (oldTarget != target) &#123;<br>            <span class="hljs-keyword">if</span> (isStarted()) &#123;<br>                cancel();<br>            &#125;<br>            <span class="hljs-comment">// 这是一个软引用,这样ObjectAnimator就不会持有View的引用，不会影响Activity的正常回收，从而不会引起Activity内存泄漏。</span><br>            mTarget = target == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;Object&gt;(target);<br>            <span class="hljs-comment">// 记录未初始化,ValueAnimator的初始化标志位</span><br>            mInitialized = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPropertyName</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> String propertyName)</span> &#123;<br>        <span class="hljs-comment">// mValues是一个数组，用于保存PropertyValuesHolder</span><br>        <span class="hljs-keyword">if</span> (mValues != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">PropertyValuesHolder</span> <span class="hljs-variable">valuesHolder</span> <span class="hljs-operator">=</span> mValues[<span class="hljs-number">0</span>];<br>            <span class="hljs-type">String</span> <span class="hljs-variable">oldName</span> <span class="hljs-operator">=</span> valuesHolder.getPropertyName();<br>            <span class="hljs-comment">// 更新第一个PropertyValuesHolder的PropertyName</span><br>            valuesHolder.setPropertyName(propertyName);<br>            <span class="hljs-comment">// mValues和mValuesMap都是存储PropertyValueHolder的属性</span><br>            mValuesMap.remove(oldName);<br>            mValuesMap.put(propertyName, valuesHolder);<br>        &#125;<br>        mPropertyName = propertyName;<br>        <span class="hljs-comment">// 记录尚未初始化,ValueAnimator的标志位</span><br>        mInitialized = <span class="hljs-literal">false</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>回到<code>ObjectAnimator.OfInt()</code>方法,查看<code>ObjectAnimator.setIntValues()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ObjectAnimator</span><br> <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIntValues</span><span class="hljs-params">(<span class="hljs-type">int</span>... values)</span> &#123;<br>        <span class="hljs-comment">// 第一次调用时，values为null</span><br>        <span class="hljs-keyword">if</span> (mValues == <span class="hljs-literal">null</span> || mValues.length == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 我们设置了mPropertyName，在这里mProperty为null</span><br>            <span class="hljs-keyword">if</span> (mProperty != <span class="hljs-literal">null</span>) &#123;<br>                setValues(PropertyValuesHolder.ofInt(mProperty, values));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                setValues(PropertyValuesHolder.ofInt(mPropertyName, values));<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">super</span>.setIntValues(values);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  进入<code>PropertyValuesHolder.ofInt(mPropertyName, values)</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// PropertyValuesHolder</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyValuesHolder <span class="hljs-title function_">ofInt</span><span class="hljs-params">(String propertyName, <span class="hljs-type">int</span>... values)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntPropertyValuesHolder</span>(propertyName, values);<br>    &#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">IntPropertyValuesHolder</span><span class="hljs-params">(String propertyName, <span class="hljs-type">int</span>... values)</span> &#123;<br>            <span class="hljs-built_in">super</span>(propertyName);<br>            <span class="hljs-comment">// 调用IntPropertyValuesHolder.setIntValues方法</span><br>            setIntValues(values);<br>        &#125;<br><br><span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIntValues</span><span class="hljs-params">(<span class="hljs-type">int</span>... values)</span> &#123;<br>            <span class="hljs-comment">// 调用PropertyValuesHolder.setIntValues方法</span><br>            <span class="hljs-built_in">super</span>.setIntValues(values);<br>            mIntKeyframes = (Keyframes.IntKeyframes) mKeyframes;<br>        &#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIntValues</span><span class="hljs-params">(<span class="hljs-type">int</span>... values)</span> &#123;<br>        <span class="hljs-comment">// 记录mValueType值，便于使用反射方式遍历获取目标target对应的set和get方法</span><br>        mValueType = <span class="hljs-type">int</span>.class;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>ObjectAnimator.ofFloat</code>的过程就结束了，</p>
<p>小结:</p>
<p>  ofInt()会创建<code>ObjecctAnimator</code>对象,并设置动画目标target和属性名propertyName,然后调用<code>PropertyValuesHolder.ofInt()</code>进行初始化</p>
<p>下面我们来看ObjectAnimator 的 <code>start()</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ObjectAnimator</span><br>   <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 取消当前的动画</span><br>        AnimationHandler.getInstance().autoCancelBasedOn(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">if</span> (DBG) &#123;<br>            Log.d(LOG_TAG, <span class="hljs-string">&quot;Anim target, duration: &quot;</span> + getTarget() + <span class="hljs-string">&quot;, &quot;</span> + getDuration());<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mValues.length; ++i) &#123;<br>                <span class="hljs-type">PropertyValuesHolder</span> <span class="hljs-variable">pvh</span> <span class="hljs-operator">=</span> mValues[i];<br>                Log.d(LOG_TAG, <span class="hljs-string">&quot;   Values[&quot;</span> + i + <span class="hljs-string">&quot;]: &quot;</span> +<br>                    pvh.getPropertyName() + <span class="hljs-string">&quot;, &quot;</span> + pvh.mKeyframes.getValue(<span class="hljs-number">0</span>) + <span class="hljs-string">&quot;, &quot;</span> +<br>                    pvh.mKeyframes.getValue(<span class="hljs-number">1</span>));<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 调用了ValueAnimator的start()</span><br>        <span class="hljs-built_in">super</span>.start();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  我们跟进<code>ValueAnimator.start()</code>-&gt;<code>ValueAnimator.setCurrent()</code>-&gt;<code>initAnimator</code></p>
<p>我们先看看<code>ObjectAnimator.initAnimation()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ObjectAnimator</span><br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">initAnimation</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 第一次执行时，mInitialized为false,初始化后该标志位置为true</span><br>        <span class="hljs-keyword">if</span> (!mInitialized) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> getTarget();<br>            <span class="hljs-keyword">if</span> (target != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">numValues</span> <span class="hljs-operator">=</span> mValues.length;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numValues; ++i) &#123;<br>                    <span class="hljs-comment">// 执行PropertyValuesHolder的setupSetterAndGetter()方法</span><br>                    mValues[i].setupSetterAndGetter(target);<br>                &#125;<br>            &#125;<br>            <span class="hljs-built_in">super</span>.initAnimation();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p> 分析<code>PropertyValuesHolder.setupSetterAndGetter()</code>,主要是初始化反射方法mSetter和mGetter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// PropertyValuesHolder</span><br> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setupSetterAndGetter</span><span class="hljs-params">(Object target)</span> &#123;<br>     <span class="hljs-comment">// 如果我们设置了mPropertyName,mProperty为null</span><br>        <span class="hljs-keyword">if</span> (mProperty != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">testValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                List&lt;Keyframe&gt; keyframes = mKeyframes.getKeyframes();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">keyframeCount</span> <span class="hljs-operator">=</span> keyframes == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : keyframes.size();<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keyframeCount; i++) &#123;<br>                    <span class="hljs-type">Keyframe</span> <span class="hljs-variable">kf</span> <span class="hljs-operator">=</span> keyframes.get(i);<br>                    <span class="hljs-keyword">if</span> (!kf.hasValue() || kf.valueWasSetOnStart()) &#123;<br>                        <span class="hljs-keyword">if</span> (testValue == <span class="hljs-literal">null</span>) &#123;<br>                            testValue = convertBack(mProperty.get(target));<br>                        &#125;<br>                        kf.setValue(testValue);<br>                        kf.setValueWasSetOnStart(<span class="hljs-literal">true</span>);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">return</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (ClassCastException e) &#123;<br>                Log.w(<span class="hljs-string">&quot;PropertyValuesHolder&quot;</span>,<span class="hljs-string">&quot;No such property (&quot;</span> + mProperty.getName() +<br>                        <span class="hljs-string">&quot;) on target object &quot;</span> + target + <span class="hljs-string">&quot;. Trying reflection instead&quot;</span>);<br>                mProperty = <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// We can&#x27;t just say &#x27;else&#x27; here because the catch statement sets mProperty to null.</span><br>         <span class="hljs-comment">// mProperty为空，判断get和set方法是否存在</span><br>        <span class="hljs-keyword">if</span> (mProperty == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">targetClass</span> <span class="hljs-operator">=</span> target.getClass();<br>            <span class="hljs-keyword">if</span> (mSetter == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 查找目标属性的set方法，初始化mSetter方法</span><br>                setupSetter(targetClass);<br>            &#125;<br>            List&lt;Keyframe&gt; keyframes = mKeyframes.getKeyframes();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">keyframeCount</span> <span class="hljs-operator">=</span> keyframes == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : keyframes.size();<br>            <span class="hljs-comment">// 遍历关键帧集合</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keyframeCount; i++) &#123;<br>                <span class="hljs-type">Keyframe</span> <span class="hljs-variable">kf</span> <span class="hljs-operator">=</span> keyframes.get(i);<br>                <span class="hljs-keyword">if</span> (!kf.hasValue() || kf.valueWasSetOnStart()) &#123;<br>                    <span class="hljs-keyword">if</span> (mGetter == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">// 查找目标属性的get方法，初始化mGetter方法</span><br>                        setupGetter(targetClass);<br>                        <span class="hljs-comment">// mGetter为null时，直接return</span><br>                        <span class="hljs-keyword">if</span> (mGetter == <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-comment">// Already logged the error - just return to avoid NPE</span><br>                            <span class="hljs-keyword">return</span>;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">// 通过mGetter反射获取属性值</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> convertBack(mGetter.invoke(target));<br>                        <span class="hljs-comment">// 初始化关键帧Keyframe的mValue值</span><br>                        kf.setValue(value);<br>                        <span class="hljs-comment">// 设置Keyframe标志位为true，表示已经初始化mValue</span><br>                        kf.setValueWasSetOnStart(<span class="hljs-literal">true</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>                        Log.e(<span class="hljs-string">&quot;PropertyValuesHolder&quot;</span>, e.toString());<br>                    &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                        Log.e(<span class="hljs-string">&quot;PropertyValuesHolder&quot;</span>, e.toString());<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>  setupSetter</code>和<code>setupGetter</code>方法都调用了<code>setupSetterOrGetter()</code>接着分析<code>setupSetterOrGetter()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// PropertyValuesHolder</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">setupSetter</span><span class="hljs-params">(Class targetClass)</span> &#123;<br>        Class&lt;?&gt; propertyType = mConverter == <span class="hljs-literal">null</span> ? mValueType : mConverter.getTargetType();<br>        mSetter = setupSetterOrGetter(targetClass, sSetterPropertyMap, <span class="hljs-string">&quot;set&quot;</span>, propertyType);<br>    &#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setupGetter</span><span class="hljs-params">(Class targetClass)</span> &#123;<br>        mGetter = setupSetterOrGetter(targetClass, sGetterPropertyMap, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-literal">null</span>);<br>    &#125;<br><br><br><br><span class="hljs-comment">// 参数prefix值为“set”或者“get”,在这里valueType为int.class</span><br>    <span class="hljs-keyword">private</span> Method <span class="hljs-title function_">setupSetterOrGetter</span><span class="hljs-params">(Class targetClass,</span><br><span class="hljs-params">            HashMap&lt;Class, HashMap&lt;String, Method&gt;&gt; propertyMapMap,</span><br><span class="hljs-params">            String prefix, Class valueType)</span> &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">setterOrGetter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// 进行同步判断</span><br>        <span class="hljs-keyword">synchronized</span>(propertyMapMap) &#123;<br>            <span class="hljs-comment">// 根据targetClass获取HashMap，这个propertyMap是以mPropertyName为key，set或者get方法作为value</span><br>            HashMap&lt;String, Method&gt; propertyMap = propertyMapMap.get(targetClass);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">wasInMap</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (propertyMap != <span class="hljs-literal">null</span>) &#123;<br>                wasInMap = propertyMap.containsKey(mPropertyName);<br>                <span class="hljs-keyword">if</span> (wasInMap) &#123;<br>                    setterOrGetter = propertyMap.get(mPropertyName);<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// 第一次初始化，wasInMap为false</span><br>            <span class="hljs-keyword">if</span> (!wasInMap) &#123;<br>                <span class="hljs-comment">// 初始化setterOrGetter</span><br>                setterOrGetter = getPropertyFunction(targetClass, prefix, valueType);<br>                <span class="hljs-keyword">if</span> (propertyMap == <span class="hljs-literal">null</span>) &#123;<br>                    propertyMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Method&gt;();<br>                    propertyMapMap.put(targetClass, propertyMap);<br>                &#125;<br>                propertyMap.put(mPropertyName, setterOrGetter);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> setterOrGetter;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>在<code>setupSetterOrGetter</code>方法中调用到了<code>getPropertyFunction</code>函数来初始化mSetter或者mGetter参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// PropertyValuesHolder</span><br><span class="hljs-keyword">private</span> Method <span class="hljs-title function_">getPropertyFunction</span><span class="hljs-params">(Class targetClass, String prefix, Class valueType)</span> &#123;<br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> faster implementation...</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">returnVal</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// 通过prefix和mPropertyName拼接出方法名，如setAlpha或者getAlpha</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> getMethodName(prefix, mPropertyName);<br>        Class args[] = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (valueType == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                returnVal = targetClass.getMethod(methodName, args);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>                <span class="hljs-comment">// Swallow the error, log it later</span><br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">1</span>];<br>            Class typeVariants[];<br>            <span class="hljs-keyword">if</span> (valueType.equals(Float.class)) &#123;<br>                typeVariants = FLOAT_VARIANTS;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valueType.equals(Integer.class)) &#123;<br>                typeVariants = INTEGER_VARIANTS;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valueType.equals(Double.class)) &#123;<br>                typeVariants = DOUBLE_VARIANTS;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                typeVariants = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">1</span>];<br>                typeVariants[<span class="hljs-number">0</span>] = valueType;<br>            &#125;<br>            <span class="hljs-comment">// FLOAT_VARIANTS,遍历含有float.class、Float.class、double.class、Double.class等参数的方法</span><br>            <span class="hljs-comment">// 只要是相关的基本类型，都会遍历反射查找set或者get方法</span><br>            <span class="hljs-keyword">for</span> (Class typeVariant : typeVariants) &#123;<br>                args[<span class="hljs-number">0</span>] = typeVariant;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// 反射获取方法，成功则直接返回</span><br>                    returnVal = targetClass.getMethod(methodName, args);<br>                    <span class="hljs-keyword">if</span> (mConverter == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">// change the value type to suit</span><br>                        mValueType = typeVariant;<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> returnVal;<br>                &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>                    <span class="hljs-comment">// Swallow the error and keep trying other variants</span><br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// If we got here, then no appropriate function was found</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (returnVal == <span class="hljs-literal">null</span>) &#123;<br>            Log.w(<span class="hljs-string">&quot;PropertyValuesHolder&quot;</span>, <span class="hljs-string">&quot;Method &quot;</span> +<br>                    getMethodName(prefix, mPropertyName) + <span class="hljs-string">&quot;() with type &quot;</span> + valueType +<br>                    <span class="hljs-string">&quot; not found on target class &quot;</span> + targetClass);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> returnVal;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  到这里ObjectAnimator的<code>initAnimation()</code>方法已经完成,接下来我们回到<code>ValueAnimator.setCurrentFraction(float fraction)</code>方法，最后调用了<code>ObjectAnimator.animateValue(float fraction)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ObjectAnimator</span><br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">animateValue</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> getTarget();<br>        <span class="hljs-comment">// mTarget是一个软引用，判断target是否已经被回收</span><br>        <span class="hljs-keyword">if</span> (mTarget != <span class="hljs-literal">null</span> &amp;&amp; target == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// We lost the target reference, cancel and clean up. Note: we allow null target if the</span><br>            <span class="hljs-comment">/// target has never been set.</span><br>            cancel();<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 这里调用父类ValueAnimator的animateValue来计算数值</span><br>        <span class="hljs-built_in">super</span>.animateValue(fraction);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numValues</span> <span class="hljs-operator">=</span> mValues.length;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numValues; ++i) &#123;<br>            <span class="hljs-comment">// 反射修改每一个属性值，这里修改完这一轮动画就结束了</span><br>            mValues[i].setAnimatedValue(target);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>  我们看看<code>PropertyValuesHolder.setAnimatedValue()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// IntPropertyValuesHolder</span><br><span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAnimatedValue</span><span class="hljs-params">(Object target)</span> &#123;<br>            <span class="hljs-comment">// 我们传进来的是mPropertyName</span><br>            <span class="hljs-keyword">if</span> (mIntProperty != <span class="hljs-literal">null</span>) &#123;<br>                mIntProperty.setValue(target, mIntAnimatedValue);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (mProperty != <span class="hljs-literal">null</span>) &#123;<br>                mProperty.set(target, mIntAnimatedValue);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (mJniSetter != <span class="hljs-number">0</span>) &#123;<br>                nCallIntMethod(target, mJniSetter, mIntAnimatedValue);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">// 终于到了，反射修改属性值就在这里执行的</span><br>            <span class="hljs-keyword">if</span> (mSetter != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    mTmpValueArray[<span class="hljs-number">0</span>] = mIntAnimatedValue;<br>                    mSetter.invoke(target, mTmpValueArray);<br>                &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>                    Log.e(<span class="hljs-string">&quot;PropertyValuesHolder&quot;</span>, e.toString());<br>                &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                    Log.e(<span class="hljs-string">&quot;PropertyValuesHolder&quot;</span>, e.toString());<br>                &#125;<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure>

<p>  到这里我们把<code>setCurrentPlayTime()</code>分析完,<code>ObjectAnimator</code>也就分析完了,其他的细节和<code>ValueAnimator</code>一样.</p>
<h2 id="转场动画"><a href="#转场动画" class="headerlink" title="转场动画"></a>转场动画</h2><p>  看完了属性动画后,我们再来看看转场动画</p>
<h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p>在 Android 5.0 之后，我们可以使用 Transition 为我们带来的转场动画。</p>
<table>
<thead>
<tr>
<th align="left">Explode</th>
<th align="left">Slide</th>
<th align="left">Fade</th>
</tr>
</thead>
<tbody><tr>
<td align="left">从中心移入或移出</td>
<td align="left">从边缘移入或移出</td>
<td align="left">调整透明度产生渐变</td>
</tr>
<tr>
<td align="left"><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Transition-Explode.gif" srcset="/img/loading.gif" lazyload alt="Transition-Explode" style="zoom: 33%;" /></td>
<td align="left"><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Transition-Slide.gif" srcset="/img/loading.gif" lazyload alt="Transition-Slide" style="zoom: 33%;" /></td>
<td align="left"><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Transition-Fade.gif" srcset="/img/loading.gif" lazyload alt="Transition-Fade" style="zoom: 33%;" /></td>
</tr>
</tbody></table>
<p>这三个类都继承于 Transition ，所有有一些属性都是共同的。 常用属性如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 设置动画的时间。</span><br>transition.setDuration();<br><span class="hljs-comment">// 设置插值器</span><br>transition.setInterpolator();<br><span class="hljs-comment">// 设置动画开始时间，延迟n毫秒播放。</span><br>transition.setStartDelay();<br><span class="hljs-comment">// 设置动画的运行路径</span><br>transition.setPathMotion();<br><span class="hljs-comment">// 改变动画 出现/消失 的模式。Visibility.MODE_IN:进入；Visibility.MODE_OUT：退出。</span><br>transition.setMode();<br><span class="hljs-comment">// 设置动画的监听事件</span><br>transition.addListener()<br></code></pre></td></tr></table></figure>

<p>插值器,与前面一致,<a href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E6%8F%92%E5%80%BC%E5%99%A8">常见的插值器</a></p>
<h4 id="Transition的时机"><a href="#Transition的时机" class="headerlink" title="Transition的时机"></a>Transition的时机</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//总共有四个过程</span><br><span class="hljs-comment">//退出 -&gt; 进入  -&gt; 返回   -&gt; 重新进入</span><br><span class="hljs-comment">//Exit -&gt; Enter -&gt; Return -&gt; Reenter</span><br><span class="hljs-comment">//界面1</span><br>android:windowExitTransition      <span class="hljs-comment">//启动新 Activity ，此页面退出的动画</span><br>android:windowReenterTransition   <span class="hljs-comment">//重新进入的动画。即第二次进入，可以和首次进入不一样。</span><br><span class="hljs-comment">//界面2</span><br>android:windowEnterTransition     <span class="hljs-comment">//首次进入显示的动画</span><br>android:windowReturnTransition    <span class="hljs-comment">//finishAfterTransition()退出时，此页面退出的动画.</span><br></code></pre></td></tr></table></figure>

<ul>
<li>首先打开页面A ：页面A -&gt; Enter 首次进入</li>
<li>从 A 打开 B ：页面A -&gt; Exit 退出 页面B -&gt; Enter 首次进入</li>
<li>从 B 返回 A ：页面B -&gt; Return 返回 页面A -&gt; Reenter 重新进入</li>
</ul>
<table>
<thead>
<tr>
<th align="left">方法</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">windowContentTransitions</td>
<td align="left">允许使用transitions</td>
</tr>
<tr>
<td align="left">windowAllowEnterTransitionOverlap</td>
<td align="left">是否覆盖执行，其实可以理解成前后两个页面是同步执行还是顺序执行</td>
</tr>
<tr>
<td align="left">windowAllowReturnTransitionOverlap</td>
<td align="left">与上面相同。即上一个设置了退出动画，这个设置了进入动画，两者是否同时执行。</td>
</tr>
<tr>
<td align="left">windowContentTransitionManager</td>
<td align="left">引用TransitionManager XML资源，定义不同窗口内容之间的所需转换。</td>
</tr>
<tr>
<td align="left">windowEnterTransition</td>
<td align="left">首次进入显示的动画</td>
</tr>
<tr>
<td align="left">windowExitTransition</td>
<td align="left">启动新 Activity ，此页面退出的动画</td>
</tr>
<tr>
<td align="left">windowReenterTransition</td>
<td align="left">重新进入的动画。即第二次进入，可以和首次进入不一样。</td>
</tr>
<tr>
<td align="left">windowReturnTransition</td>
<td align="left">调用 finishAfterTransition() 退出时，此页面退出的动画</td>
</tr>
<tr>
<td align="left">windowSharedElementsUseOverlay</td>
<td align="left">指示共享元素在转换期间是否应使用叠加层。</td>
</tr>
<tr>
<td align="left">windowSharedElementEnterTransition</td>
<td align="left">首次进入显示的动画</td>
</tr>
<tr>
<td align="left">windowSharedElementExitTransition</td>
<td align="left">启动新 Activity ，此页面退出的动画</td>
</tr>
<tr>
<td align="left">windowSharedElementReenterTransition</td>
<td align="left">重新进入的动画。即第二次进入，可以和首次进入不一样。</td>
</tr>
<tr>
<td align="left">windowSharedElementReturnTransition</td>
<td align="left">调用 finishAfterTransition() 退出时，此页面退出的动画</td>
</tr>
</tbody></table>
<h4 id="跳转页面"><a href="#跳转页面" class="headerlink" title="跳转页面"></a>跳转页面</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//页面1 (Activity默认了一个从右到左的Slide动画)</span><br><span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-keyword">this</span>, MainActivity2::<span class="hljs-keyword">class</span>.java)<br>        startActivity(intent)<br><br><span class="hljs-comment">//页面2可以什么也不写</span><br><span class="hljs-comment">// 如果定义了 return transition ，将使用定义的动画过渡</span><br>        window.returnTransition = Fade()<br><span class="hljs-comment">// 如果没有定义returnTransition，将使用 反转进入 的动画</span><br>    finishAfterTransition();<br></code></pre></td></tr></table></figure>

<p><strong>Shared Elements Transition 共享元素</strong></p>
<p>携带需要共享的 View 进行跳转, 也就是在跳转的参数中，增加了要共享的 View控件。</p>
<ol>
<li><p>先在 layout 布局里面给需要共享的元素加上transitionName：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">android:transitionName=&quot;image&quot;<br></code></pre></td></tr></table></figure>
</li>
<li><p>然后开始设置跳转页面，代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-keyword">this</span>, MainActivity2::<span class="hljs-keyword">class</span>.java)<br>        <span class="hljs-keyword">val</span> transitionActivityOptions =<br>            ActivityOptionsCompat.makeSceneTransitionAnimation(<span class="hljs-keyword">this</span>, Pair(textView, <span class="hljs-string">&quot;translation1&quot;</span>))<br>        startActivity(intent, transitionActivityOptions.toBundle())<br></code></pre></td></tr></table></figure></li>
</ol>
<p>和普通Transition区别是增加了<code>Pair.create()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Pair.create（<br>   View view,      <span class="hljs-comment">// 本页面要共享的 View</span><br>   String resId    <span class="hljs-comment">// 设置的transitionName</span><br>）<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Activity-%E5%85%B1%E4%BA%AB%E5%85%83%E7%B4%A0.gif" srcset="/img/loading.gif" lazyload alt="Activity-共享元素" style="zoom: 50%;" />

<p>  fragment与fragment之间地动画</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//在fragment1中</span><br><span class="hljs-keyword">val</span> fragment2 = Fragment2()<br>            <span class="hljs-keyword">this</span>.exitTransition = Explode()<br>            fragment2.enterTransition = Slide()<br>            requireActivity().supportFragmentManager.beginTransaction()<br>                .addSharedElement(textView, <span class="hljs-string">&quot;translation2&quot;</span>)<br>                .replace(R.id.constraintLayout3, fragment2).addToBackStack(<span class="hljs-literal">null</span>).commit()<br><br><span class="hljs-comment">//在fragment2中</span><br>sharedElementEnterTransition = TransitionInflater.from(getContext())<br>            .inflateTransition(android.R.transition.move);<br></code></pre></td></tr></table></figure>

<p>  可以设置一些界面切换的效果,和Transition用法一致</p>
<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/wE2KrFdqeT8z4BO.gif" srcset="/img/loading.gif" lazyload alt="fragment-共享元素" style="zoom: 50%;" />

<p>  注意:有时从<code>RecyclerView</code>界面进入到详情页，由于详情页加载延迟，可能出现没有效果。例如<code>ImageView</code>从网络加载图片，可能A界面到B界面没效果，B回到A界面有效果。</p>
<p>例如:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Shared_Transition_no_Postpone.gif" srcset="/img/loading.gif" lazyload alt="Shared_Transition_no_Postpone" style="zoom: 50%;" />

<p>  解决步骤：</p>
<ul>
<li><p>在<code>setContentView</code>后添加代码<code>postponeEnterTransition()</code>，延迟加载过渡动画。</p>
</li>
<li><p>在共享元素视图加载完毕，或者图片加载完毕后调用代码<code>startPostponedEnterTransition()</code>,开始加载过渡动画。</p>
</li>
</ul>
<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Shared_transition_no_exit_retreen.gif" srcset="/img/loading.gif" lazyload alt="Shared_transition_no_exit_retreen" style="zoom: 50%;" />

<p>当Activity A 调用 Activity B ，发生的事件流如下：</p>
<p>1）Activity A调用startActivity()，ActivityB被创建，测量，同时初始化为半透明的窗口和透明的背景颜色。</p>
<p>2）framework重新分配每个共享元素在B中的位置与大小，使其跟A中一模一样。之后，B的进入变换（enter transition）捕获到共享元素在B中的初始状态。</p>
<p>3）framework重新分配每个共享元素在B中的位置与大小，使其跟B中的最终状态一致。之后，B的进入变换（enter transition）捕获到共享元素在B中的结束状态。</p>
<p>4）B的进入变换（enter transition）比较共享元素的初始和结束状态，同时基于前后状态的区别创建一个Animator(属性动画对象)。</p>
<p>5）framework 命令A隐藏其共享元素，动画开始运行。随着动画的进行，framework 逐渐将B的activity窗口显示出来，当动画完成，B的窗口才完全可见。</p>
<h4 id="TransitionManager-控制动画"><a href="#TransitionManager-控制动画" class="headerlink" title="TransitionManager 控制动画"></a>TransitionManager 控制动画</h4><p>  Activity切换过渡动画指在两个Activity之间，而布局变化过渡动画，是指同个Activity之间View的变化过渡动画。</p>
<p>  具体步骤: 需要我们自己创建起始和结束场景，利用现有的过渡效果来达到两个场景的切换 (起始场景和结束场景需要用相同根元素) 。默认情况下，当前界面就是起始场景。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--第一步创建scene2--&gt;</span><br><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/constraintLayout2&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;.MainActivity2&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/textView2&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;Red_Rock&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">&quot;@color/purple_200&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;60dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">&quot;bold&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:transitionName</span>=<span class="hljs-string">&quot;translation1&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">&quot;parent&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/ball3&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">&quot;128dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@color/purple_200&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:src</span>=<span class="hljs-string">&quot;@drawable/drawable&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">&quot;parent&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/ball4&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">&quot;16dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@color/teal_200&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:src</span>=<span class="hljs-string">&quot;@drawable/drawable&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toBottomOf</span>=<span class="hljs-string">&quot;@+id/ball3&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/ball5&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">&quot;16dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@color/black&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:src</span>=<span class="hljs-string">&quot;@drawable/drawable&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toBottomOf</span>=<span class="hljs-string">&quot;@+id/ball4&quot;</span> /&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/button11&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginBottom</span>=<span class="hljs-string">&quot;8dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;旋转&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toStartOf</span>=<span class="hljs-string">&quot;@+id/button12&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">&quot;parent&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/button12&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginBottom</span>=<span class="hljs-string">&quot;8dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;平移&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toStartOf</span>=<span class="hljs-string">&quot;@+id/button14&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toEndOf</span>=<span class="hljs-string">&quot;@+id/button11&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/button13&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginBottom</span>=<span class="hljs-string">&quot;8dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;缩放&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toEndOf</span>=<span class="hljs-string">&quot;@+id/button14&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/button14&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginBottom</span>=<span class="hljs-string">&quot;8dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;透明&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toStartOf</span>=<span class="hljs-string">&quot;@+id/button13&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toEndOf</span>=<span class="hljs-string">&quot;@+id/button12&quot;</span> /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 第二步调用 Scene.getSceneForLayout() 保存每个Layout；</span><br><span class="hljs-keyword">val</span> scene = Scene.getSceneForLayout(constraintLayout, R.xml.scene2, <span class="hljs-keyword">this</span>)<br><span class="hljs-comment">// 第三步调用 TransitionManager.go(scene1, new ChangeBounds()) 切换。</span><br><span class="hljs-comment">// 参数1表示结束场景, 参数2表示过渡效果</span><br>TransitionManager.go(scene, ChangeBounds())<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/TransitionManager-%E5%8A%A8%E7%94%BB.gif" srcset="/img/loading.gif" lazyload alt="TransitionManager-动画" style="zoom: 50%;" />

<p><strong>过渡动画</strong></p>
<p>  系统支持将任何扩展Visibility类的过渡作为进入或退出过渡，内置继承自Visibility的类有<code>Explode</code>、<code>Slide</code>、<code>Fade</code>；支持共享元素过渡的有： </p>
<ul>
<li>changeScroll 为目标视图滑动添加动画效果</li>
<li>changeBounds 为目标视图布局边界的变化添加动画效果</li>
<li>changeClipBounds 为目标视图裁剪边界的变化添加动画效果</li>
<li>changeTransform  为目标视图缩放和旋转方面的变化添加动画效果</li>
<li>changeImageTransform  为目标图片尺寸和缩放方面的变化添加动画效果</li>
</ul>
<p> 默认转场动画会对所有的子View进行遍历加载动画, 但是如果<strong>添加目标</strong>则不会进行遍历所有子View, 或者也可以排除特定View.</p>
<p>对于目标有三个操作:</p>
<ul>
<li><p>添加(<code>addTarget</code>):默认会进行遍历所有的视图加载动画, 但是如果使用了添加就不会遍历所有, 只会让指定的视图进行动画</p>
</li>
<li><p>排除(<code>excludeTarget()</code>):如果使用排除方法, 依旧会进行遍历视图对象, 不过会排除你指定的视图</p>
</li>
<li><p>删除(<code>removeTarget()</code>):删除目标是在动画已经遍历视图完成以后还想对目标集合进行变更, 就可以删除指定的视图</p>
<p>添加&#x2F;排除和删除目标支持的参数类型: <code>视图对象(View)</code>,<code>过渡名(TransitionNames)</code>,<code>字节码(Class)</code>,<code>ID</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 视图动画</span><br>Transition <span class="hljs-title function_">addTarget</span> <span class="hljs-params">(View target)</span><br><span class="hljs-comment">// 过渡名</span><br>Transition <span class="hljs-title function_">addTarget</span> <span class="hljs-params">(String targetName)</span><br><span class="hljs-comment">// 字节码</span><br>Transition <span class="hljs-title function_">addTarget</span> <span class="hljs-params">(Class targetType)</span><br><span class="hljs-comment">// Id</span><br>Transition <span class="hljs-title function_">addTarget</span> <span class="hljs-params">(<span class="hljs-type">int</span> targetId)</span><br></code></pre></td></tr></table></figure>

<h4 id="自定义Translation"><a href="#自定义Translation" class="headerlink" title="自定义Translation"></a>自定义Translation</h4><p>  当现有的过渡效果不满足日常需求时，可以通过继承<code>Transition</code>，定制自己的动画特效。</p>
<p>子类继承<code>Transition</code>类，并重写其三个方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTransition</span> : <span class="hljs-type">Transition</span>() &#123;<br>   <span class="hljs-comment">// 捕获动画的起始值</span><br>   <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">captureStartValues</span><span class="hljs-params">(transitionValues: <span class="hljs-type">TransitionValues</span>?)</span></span> &#123;&#125;<br>   <span class="hljs-comment">// 捕获动画的结束值</span><br>   <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">captureEndValues</span><span class="hljs-params">(transitionValues: <span class="hljs-type">TransitionValues</span>?)</span></span> &#123;&#125;<br><br>   <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createAnimator</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">       sceneRoot: <span class="hljs-type">ViewGroup</span>?,</span></span><br><span class="hljs-params"><span class="hljs-function">       startValues: <span class="hljs-type">TransitionValues</span>?,</span></span><br><span class="hljs-params"><span class="hljs-function">       endValues: <span class="hljs-type">TransitionValues</span>?</span></span><br><span class="hljs-params"><span class="hljs-function">   )</span></span>: Animator &#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.createAnimator(sceneRoot, startValues, endValues)<br>   &#125;<br>   <br>&#125;<br><br><span class="hljs-comment">// 来看看TransitionValues这个类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransitionValues</span> &#123;<br>    <span class="hljs-comment">// 捕获的View</span><br>    <span class="hljs-keyword">public</span> View view;<br>    <span class="hljs-comment">// 存放我们收集的信息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; values = new ArrayMap&lt;String, Object&gt;();<br><br>    <span class="hljs-keyword">final</span> ArrayList&lt;Transition&gt; targetedTransitions = new ArrayList&lt;Transition&gt;();<br></code></pre></td></tr></table></figure>

<p><code>captureStartValues()</code>与<code>captureEndValues()</code>方法是必须实现的，和结束值，而<code>createAnimator()</code>方法，是用来创建自定义的动画。</p>
<p>参数<code>TransitionValues</code>可以理解是用来存储View的一些属性值，参数<code>sceneRoot</code>为根视图。</p>
<p>先看效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/%E8%87%AA%E5%AE%9A%E4%B9%89Transition.gif" srcset="/img/loading.gif" lazyload alt="自定义Transition" style="zoom: 50%;" />

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTransition</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Transition</span> &#123;<br>    <span class="hljs-comment">// 收集高度和宽度</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;top&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HEIGHT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;height&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">captureStartValues</span><span class="hljs-params">(TransitionValues transitionValues)</span> &#123;<br>        <span class="hljs-comment">// 拿到我们的目标view</span><br>        <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> transitionValues.view;<br>        <span class="hljs-type">Rect</span> <span class="hljs-variable">rect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rect</span>();<br>        <span class="hljs-comment">// 拿到它的父布局上下左右的距离</span><br>        view.getHitRect(rect);<br>        <span class="hljs-comment">// 保存到values</span><br>        transitionValues.values.put(TOP, rect.top);<br>        transitionValues.values.put(HEIGHT, view.getHeight());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">captureEndValues</span><span class="hljs-params">(TransitionValues transitionValues)</span> &#123;<br>        <span class="hljs-comment">// 和上面同理</span><br>        transitionValues.values.put(TOP, <span class="hljs-number">0</span>);<br>        transitionValues.values.put(HEIGHT, transitionValues.view.getHeight());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Animator <span class="hljs-title function_">createAnimator</span><span class="hljs-params">(ViewGroup sceneRoot, TransitionValues startValues, TransitionValues endValues)</span> &#123;<br>        <span class="hljs-keyword">if</span> (startValues == <span class="hljs-literal">null</span> || endValues == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">// 初始化</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">endView</span> <span class="hljs-operator">=</span> endValues.view;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">startTop</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) startValues.values.get(TOP);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">startHeight</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) startValues.values.get(HEIGHT);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">endTop</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) endValues.values.get(TOP);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">endHeight</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) endValues.values.get(HEIGHT);<br>        <span class="hljs-comment">// 首先把view的高度设置为前一个界面上view的高度是为了防止在移动的过程中view的高度是他自身的高度的.</span><br>        endView.setTranslationY(startTop);<br>        endView.getLayoutParams().height = startHeight;<br>        endView.requestLayout();<br>        <span class="hljs-comment">// 移动动画</span><br>        <span class="hljs-type">ValueAnimator</span> <span class="hljs-variable">positionAnimator</span> <span class="hljs-operator">=</span> ValueAnimator.ofInt(startTop, endTop);<br>        positionAnimator.setDuration(<span class="hljs-number">200</span>);<br>        positionAnimator.setInterpolator(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearInterpolator</span>());<br>        positionAnimator.addUpdateListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueAnimator</span>.AnimatorUpdateListener() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationUpdate</span><span class="hljs-params">(ValueAnimator animation)</span> &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) positionAnimator.getAnimatedValue();<br>                endView.setTranslationY(current);<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">// 展开动画</span><br>        <span class="hljs-type">ValueAnimator</span> <span class="hljs-variable">sizeAnimator</span> <span class="hljs-operator">=</span> ValueAnimator.ofInt(startHeight, endHeight);<br>        sizeAnimator.setDuration(<span class="hljs-number">200</span>);<br>        sizeAnimator.setInterpolator(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearInterpolator</span>());<br>        sizeAnimator.addUpdateListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueAnimator</span>.AnimatorUpdateListener() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationUpdate</span><span class="hljs-params">(ValueAnimator valueAnimator)</span> &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) valueAnimator.getAnimatedValue();<br>                endView.getLayoutParams().height = current;<br>                endView.requestLayout();<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">// 动画集合</span><br>        <span class="hljs-type">AnimatorSet</span> <span class="hljs-variable">set</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimatorSet</span>();<br>        set.play(sizeAnimator).after(positionAnimator);<br>        <span class="hljs-keyword">return</span> set;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>  下面是跳转代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">    <span class="hljs-comment">// 界面1中</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startActivity</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, msg: <span class="hljs-type">String</span>)</span></span> &#123;<br>        <span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-keyword">this</span>, MainActivity5::<span class="hljs-keyword">class</span>.java)<br>        intent.putExtra(<span class="hljs-string">&quot;msg&quot;</span>, msg)<br>        <span class="hljs-keyword">val</span> pair1 = Pair.create(view, view.transitionName)<br>        <span class="hljs-comment">// 和前面的操作一样</span><br>        <span class="hljs-keyword">val</span> compat =<br>            ActivityOptionsCompat.makeSceneTransitionAnimation(<span class="hljs-keyword">this</span>, pair1)<br>        ActivityCompat.startActivity(<span class="hljs-keyword">this</span>, intent, compat.toBundle())<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 界面2中</span><br><span class="hljs-keyword">val</span> textView = findViewById&lt;TextView&gt;(R.id.textView5)<br>        textView.text = intent.getStringExtra(<span class="hljs-string">&quot;msg&quot;</span>)<br>        <span class="hljs-keyword">val</span> transition = MyTransition()<br>        <span class="hljs-comment">// 这个target就是我们设置的transitionName</span><br>        transition.addTarget(<span class="hljs-string">&quot;transition2&quot;</span>)<br>        <span class="hljs-comment">// 设置成我们自定义的Transition</span><br>        window.sharedElementEnterTransition = transition<br></code></pre></td></tr></table></figure>

<p>  这里有一个NavigationBar会有闪烁问题,原因是共享元素动画是在整个窗口的view上执行的,解决方法就是将导航栏作为动画的一部分,然后在界面2中延迟动画,有两个方法来延迟动画执行: <code>postponeEnterTransition()</code>和<code>startPostponedEnterTransition()</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 界面1</span><br><span class="hljs-keyword">val</span> decor = window.decorView<br>        decor.viewTreeObserver.addOnPreDrawListener(<span class="hljs-keyword">object</span> : ViewTreeObserver.OnPreDrawListener &#123;<br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPreDraw</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> &#123;<br>                decor.viewTreeObserver.removeOnPreDrawListener(<span class="hljs-keyword">this</span>)<br>                <span class="hljs-comment">// 从根布局获得statusBar和navigationBar实例</span><br>                statusBar = decor.findViewById&lt;View&gt;(android.R.id.statusBarBackground)<br>                navigationBar = findViewById&lt;View&gt;(android.R.id.navigationBarBackground)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;)<br>    <span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-keyword">this</span>, MainActivity5::<span class="hljs-keyword">class</span>.java)<br>    intent.putExtra(<span class="hljs-string">&quot;msg&quot;</span>, msg)<br>    <span class="hljs-keyword">val</span> pair1 = Pair.create(view, view.transitionName)<br>    <span class="hljs-comment">// 给statusBar和navigationBar加上动画</span><br>    <span class="hljs-keyword">val</span> pair2 = Pair.create(statusBar, Window.STATUS_BAR_BACKGROUND_TRANSITION_NAME)<br>    <span class="hljs-keyword">val</span> pair3 = Pair.create(navigationBar, Window.NAVIGATION_BAR_BACKGROUND_TRANSITION_NAME)<br>    <span class="hljs-keyword">val</span> compat =<br>        ActivityOptionsCompat.makeSceneTransitionAnimation(<span class="hljs-keyword">this</span>, pair1,pair2,pair3 )<br>    ActivityCompat.startActivity(<span class="hljs-keyword">this</span>, intent, compat.toBundle())<br><br><span class="hljs-comment">//界面2</span><br><span class="hljs-keyword">val</span> textView = findViewById&lt;TextView&gt;(R.id.textView5)<br>        textView.text = intent.getStringExtra(<span class="hljs-string">&quot;msg&quot;</span>)<br>        postponeEnterTransition()<br>        <span class="hljs-keyword">val</span> decorView = window.decorView<br>        window.decorView.viewTreeObserver.addOnPreDrawListener(<span class="hljs-keyword">object</span> :<br>            ViewTreeObserver.OnPreDrawListener &#123;<br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPreDraw</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> &#123;<br>                decorView.viewTreeObserver.removeOnPreDrawListener(<span class="hljs-keyword">this</span>)<br>                supportStartPostponedEnterTransition()<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;)<br>        <span class="hljs-keyword">val</span> transition = MyTransition()<br>        transition.addTarget(<span class="hljs-string">&quot;transition2&quot;</span>)<br>        window.sharedElementEnterTransition = transition<br></code></pre></td></tr></table></figure>



<h4 id="Transition源码"><a href="#Transition源码" class="headerlink" title="Transition源码"></a>Transition源码</h4><p>  这个有点多,我就贴个链接,想了解的自己看一下</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903488040747015">Android Transition源码分析 - 掘金</a></p>
<h3 id="Material-Motion"><a href="#Material-Motion" class="headerlink" title="Material Motion"></a>Material Motion</h3><p>​    <strong>Material Design YYDS</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs groovy">implementation <span class="hljs-string">&#x27;com.google.android.material:material:1.6.0&#x27;</span><br></code></pre></td></tr></table></figure>

<p>  <code>MaterialContainerTransform</code> 是一个共享元素动画，但和传统的Android共享元素动画不同，它不是围绕单一的共享内容(如图像)设计的。这里的共享元素指的是开始视图或ViewGroup容器将其大小和形状转换为结束视图或ViewGroup容器的大小和形状，可以理解为开始和结束容器视图是容器转换的“共享元素”。并且可以用在 Fragments, Activities 或者 Views.</p>
<p>material-motion-android 是MDC-Android库中的一组过渡模式; 其中主要包含四种过渡模式:</p>
<ul>
<li><strong>ContainerTransform</strong> : 包含 container 的UI元素之间的转换 在两个不同的UI元素之间创建可见连接, 使一个UI元素无缝过渡到另一个UI元素.</li>
<li><strong>SharedAxis</strong> : 具有空间或导航关系的UI元素之间的过渡; 在X,Y或Z轴上使用共享变换来加强元素之间的关系.</li>
<li><strong>FadeThrough</strong> : 在彼此之间没有密切关系的UI元素之间进行过渡; 使用顺序淡入和淡入, 以及传入元素的比例.</li>
<li><strong>Fade</strong> : 用于在屏幕范围内进入或退出的UI元素.</li>
</ul>
<p>一些常用函数</p>
<ul>
<li><strong>fadeMode</strong></li>
</ul>
<p>设置淡入淡出模式，用于将开始视图的内容与结束视图的内容切换。 有四种淡入淡出模式：</p>
<p><code>FADE_MODE_IN</code> ：淡入传入内容，而不更改传出内容的不透明度。 这是默认模式。</p>
<p><code>FADE_MODE_OUT</code> ：淡出输出内容而不更改输入内容的不透明度。</p>
<p><code>FADE_MODE_CROSS</code> ：淡入淡出传入的内容。</p>
<p><code>FADE_MODE_THROUGH</code> ： <code>FADE_MODE_THROUGH</code>淡出输出内容并淡入输入内容。</p>
<ul>
<li><strong>fitMode</strong></li>
</ul>
<p>共有三个选项：</p>
<p><code>FIT_MODE_HEIGHT</code> ：在缩放动画期间，将传入内容调整为传出内容的高度。</p>
<p><code>FIT_MODE_WIDTH</code> ：在缩放动画过程中，使传入内容适合传出内容的宽度。</p>
<p><code>FIT_MODE_AUTO</code> ：自动使用FIT_MODE_HEIGHT或FIT_MODE_WIDTH。</p>
<ul>
<li><strong>containerColor</strong></li>
</ul>
<p>设置变形容器的背景颜色。 此颜色绘制在开始视图和结束视图下方。 当一个或两个都不具有纯色背景时，这非常有用。 这也可以用来设置过渡的颜色，以增强从一种视图到另一种视图的转化。</p>
<ul>
<li><strong>scrimColor</strong></li>
</ul>
<p>设置要在drawingView范围内的变形容器下绘制的颜色。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildContainerTransform</span><span class="hljs-params">()</span></span> =<br>        MaterialContainerTransform().apply &#123;<br>            startView =findViewById(R.id.floatingActionBar1)<br>            endView =findViewById(R.id.materialCardView1)<br>            duration = <span class="hljs-number">300</span><br>            scrimColor = Color.TRANSPARENT<br>            containerColor =<br>                requireContext().themeColor(com.google.android.material.R.attr.colorSurface)<br>            addTarget(binding.coordinator)<br>            pathMotion = MaterialArcMotion()<br>            fadeMode = MaterialContainerTransform.FADE_MODE_IN<br>            interpolator = FastOutSlowInInterpolator()<br>        &#125;<br></code></pre></td></tr></table></figure>

<h4 id="MaterialContainerTransform"><a href="#MaterialContainerTransform" class="headerlink" title="MaterialContainerTransform"></a>MaterialContainerTransform</h4><p>MDC-Android 库中的容器转换称为 <code>MaterialContainerTransform</code>。默认情况下，这个 <code>Transition</code> 子类会作为共享元素过渡运行，当带有 <code>transitionName</code> 标记时，Android 过渡系统可以选择两个采用不同布局的视图。</p>
<p>首先在两个fragment中设置共享view的translationName</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">android:transitionName=&quot;transitionName&quot;<br></code></pre></td></tr></table></figure>

<p>  在fragment3中</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 设置退出和重进入动画</span><br>exitTransition = MaterialElevationScale(<span class="hljs-literal">false</span>).apply &#123;<br>    duration = <span class="hljs-number">300</span><br>&#125;<br>reenterTransition = MaterialElevationScale(<span class="hljs-literal">true</span>).apply &#123;<br>    duration = <span class="hljs-number">300</span><br>&#125;<br><span class="hljs-keyword">val</span> fragment4 = Fragment4()<br><span class="hljs-keyword">val</span> bundle = Bundle()<br>bundle.putString(<span class="hljs-string">&quot;param1&quot;</span>, msg)<br>bundle.putString(<span class="hljs-string">&quot;param2&quot;</span>, view.transitionName)<br>fragment4.arguments = bundle<br>requireActivity().supportFragmentManager.beginTransaction()<br>    .addSharedElement(view, view.transitionName)<br>    .replace(R.id.constraintLayout4, fragment4).addToBackStack(<span class="hljs-literal">null</span>).commit()<br></code></pre></td></tr></table></figure>

<p>设置延迟动画</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">postponeEnterTransition()<br>view.doOnPreDraw &#123; startPostponedEnterTransition() &#125;<br></code></pre></td></tr></table></figure>

<p>在fragment4中</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">sharedElementEnterTransition = MaterialContainerTransform().apply &#123;<br>    duration = <span class="hljs-number">500</span><br>    scrimColor = Color.TRANSPARENT<br>    setAllContainerColors(<br>        requireContext().obtainStyledAttributes(intArrayOf(com.google.android.material.R.attr.colorSurface))<br>            .use &#123;<br>                it.getColor(<span class="hljs-number">0</span>, Color.MAGENTA)<br>            &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>为确保将 <code>MaterialElevationScale</code> 过渡应用到整个主屏幕在根布局下标记过渡组</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">android:transitionGroup=&quot;true&quot;<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/Shared_transition_final.gif" srcset="/img/loading.gif" lazyload alt="Shared_transition_final" style="zoom: 50%;" />

<h4 id="MaterialElevationScale"><a href="#MaterialElevationScale" class="headerlink" title="MaterialElevationScale"></a>MaterialElevationScale</h4><p>在fragment5中</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">enterTransition = MaterialContainerTransform().apply &#123;<br>    startView = requireActivity().findViewById(R.id.floatingActionBar1)<br>    endView = requireView().findViewById(R.id.materialCardView1)<br>    duration = <span class="hljs-number">300</span><br>    scrimColor = Color.TRANSPARENT<br>    containerColor =<br>        requireContext().themeColor(com.google.android.material.R.attr.colorSurface)<br>    startContainerColor =<br>        requireContext().themeColor(com.google.android.material.R.attr.colorSecondary)<br>    endContainerColor =<br>        requireContext().themeColor(com.google.android.material.R.attr.colorSurface)<br>&#125;<br>returnTransition = Slide().apply &#123;<br>    duration = <span class="hljs-number">300</span><br>    addTarget(R.id.materialCardView1)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在fragment3中</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">exitTransition = MaterialElevationScale(<span class="hljs-literal">false</span>).apply &#123;<br>    duration = <span class="hljs-number">300</span><br>&#125;<br>reenterTransition = MaterialElevationScale(<span class="hljs-literal">true</span>).apply &#123;<br>    duration = <span class="hljs-number">300</span><br>&#125;<br><span class="hljs-keyword">val</span> fragment5 = Fragment5()<br>requireActivity().supportFragmentManager.beginTransaction()<br>    .replace(R.id.constraintLayout4, fragment5).addToBackStack(<span class="hljs-literal">null</span>).commit()<br></code></pre></td></tr></table></figure>

<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MaterialElevationScale.gif" srcset="/img/loading.gif" lazyload alt="MaterialElevationScale" style="zoom: 50%;" />

<h4 id="MaterialSharedAxis"><a href="#MaterialSharedAxis" class="headerlink" title="MaterialSharedAxis"></a>MaterialSharedAxis</h4><p>  在fragment3</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 离开时放大过渡</span><br>exitTransition = MaterialSharedAxis(MaterialSharedAxis.Z, <span class="hljs-literal">true</span>).apply &#123;<br>    duration = <span class="hljs-number">300</span><br>&#125;<br><span class="hljs-comment">// 重新返回时缩小过渡</span><br>reenterTransition = MaterialSharedAxis(MaterialSharedAxis.Z, <span class="hljs-literal">false</span>).apply &#123;<br>    duration = <span class="hljs-number">300</span><br>&#125;<br><span class="hljs-keyword">val</span> fragment6 = Fragment6()<br>requireActivity().supportFragmentManager.beginTransaction()<br>    .replace(R.id.constraintLayout4, fragment6).addToBackStack(<span class="hljs-literal">null</span>).commit()<br></code></pre></td></tr></table></figure>

<p>在fragment6</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 进入时放大过渡</span><br>enterTransition = MaterialSharedAxis(MaterialSharedAxis.Z, <span class="hljs-literal">true</span>).apply &#123;<br>    duration = <span class="hljs-number">300</span><br>&#125;<br><span class="hljs-comment">// 返回时缩小过渡</span><br>returnTransition = MaterialSharedAxis(MaterialSharedAxis.Z, <span class="hljs-literal">false</span>).apply &#123;<br>    duration = <span class="hljs-number">300</span><br>&#125;<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>MaterialSharedAxis.X</th>
<th>MaterialSharedAxis.Y</th>
<th>MaterialSharedAxis.Z</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MaterialSharedAxis-X.gif" srcset="/img/loading.gif" lazyload alt="MaterialSharedAxis-X" style="zoom: 30%;" /></td>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MaterialSharedAxis-Y.gif" srcset="/img/loading.gif" lazyload alt="MaterialSharedAxis-Y" style="zoom: 30%;" /></td>
<td><img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MaterialSharedAxis-Z.gif" srcset="/img/loading.gif" lazyload alt="MaterialSharedAxis-Z" style="zoom: 30%;" /></td>
</tr>
</tbody></table>
<h4 id="MaterialFadeThrough"><a href="#MaterialFadeThrough" class="headerlink" title="MaterialFadeThrough"></a>MaterialFadeThrough</h4><p>在fragment3</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">exitTransition = MaterialFadeThrough().apply &#123;<br>                duration = <span class="hljs-number">300</span><br>            &#125;<br>            <span class="hljs-keyword">val</span> fragment7 = Fragment7()<br>            requireActivity().supportFragmentManager.beginTransaction()<br>                .replace(R.id.constraintLayout4, fragment7).addToBackStack(<span class="hljs-literal">null</span>).commit()<br></code></pre></td></tr></table></figure>

<p>在fragment7</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">enterTransition = MaterialFadeThrough().apply &#123;<br>    duration = <span class="hljs-number">300</span><br>&#125;<br></code></pre></td></tr></table></figure>

<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/MaterialFadeThrough.gif" srcset="/img/loading.gif" lazyload alt="MaterialFadeThrough" style="zoom: 50%;" />

<h4 id="View的MaterialContainerTransform"><a href="#View的MaterialContainerTransform" class="headerlink" title="View的MaterialContainerTransform"></a>View的MaterialContainerTransform</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 展开动画</span><br><span class="hljs-keyword">val</span> transform = MaterialContainerTransform().apply &#123;<br>            startView = chip<br>            endView = materialCardView2<br>            scrimColor = Color.TRANSPARENT<br>            endElevation = <span class="hljs-number">3f</span><br>            addTarget(materialCardView2)<br>        &#125;<br>        TransitionManager.beginDelayedTransition(constraintLayout, transform)<br><span class="hljs-comment">// 收缩动画</span><br><span class="hljs-keyword">val</span> transform = MaterialContainerTransform().apply &#123;<br>            startView = materialCardView2<br>            endView = chip<br>            scrimColor = Color.TRANSPARENT<br>            startElevation = <span class="hljs-number">3f</span><br>            addTarget(chip)<br>        &#125;<br>        TransitionManager.beginDelayedTransition(constraintLayout, transform)<br></code></pre></td></tr></table></figure>

<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/View-MaterialContainerTransform.gif" srcset="/img/loading.gif" lazyload alt="View-MaterialContainerTransform" style="zoom: 50%;" />



<h3 id="其他的一些动画"><a href="#其他的一些动画" class="headerlink" title="其他的一些动画"></a>其他的一些动画</h3><h4 id="RecyclerView入场动画"><a href="#RecyclerView入场动画" class="headerlink" title="RecyclerView入场动画"></a>RecyclerView入场动画</h4><p>在xml里设置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">set</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:duration</span>=<span class="hljs-string">&quot;200&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">translate</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:fromXDelta</span>=<span class="hljs-string">&quot;-50%p&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:toXDelta</span>=<span class="hljs-string">&quot;0&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">alpha</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:fromAlpha</span>=<span class="hljs-string">&quot;0.0&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:toAlpha</span>=<span class="hljs-string">&quot;1.0&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在初始化recyclerView时</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">recyclerView.layoutAnimation = <span class="hljs-comment">// 入场动画</span><br>            LayoutAnimationController(<br>                AnimationUtils.loadAnimation(<br>                    context,<br>                    R.anim.recycler_view_fade_in<br>                )<br>            )<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/ehwoWQDFGOZb8kz.gif" srcset="/img/loading.gif" lazyload alt="RecyclerView-入场动画" style="zoom: 50%;" />

<h4 id="ViewPager2的切换动画"><a href="#ViewPager2的切换动画" class="headerlink" title="ViewPager2的切换动画"></a>ViewPager2的切换动画</h4><p>先继承viewPager2.PageTransformer</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MAX_ROTATION = <span class="hljs-number">90f</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MIN_SCALE = <span class="hljs-number">0.9f</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SquareBoxTransformer</span> : <span class="hljs-type">ViewPager2.PageTransformer</span> &#123;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transformPage</span><span class="hljs-params">(page: <span class="hljs-type">View</span>, position: <span class="hljs-type">Float</span>)</span></span> &#123;<br>        page.apply &#123;<br>            pivotY = height / <span class="hljs-number">2f</span><br>            <span class="hljs-keyword">when</span> &#123;<br>                position &lt; -<span class="hljs-number">1</span> -&gt; &#123;<br>                    <span class="hljs-comment">// This page is way off-screen to the left.</span><br>                    rotationY = -MAX_ROTATION<br>                    pivotX = width.toFloat()<br>                &#125;<br>                position &lt;= <span class="hljs-number">1</span> -&gt; &#123;<br>                    rotationY = position * MAX_ROTATION<br>                    <span class="hljs-keyword">if</span> (position &lt; <span class="hljs-number">0</span>) &#123;<br>                        pivotX = width.toFloat()<br>                        <span class="hljs-keyword">val</span> scale =<br>                            MIN_SCALE + <span class="hljs-number">4f</span> * (<span class="hljs-number">1f</span> - MIN_SCALE) * (position + <span class="hljs-number">0.5f</span>) * (position + <span class="hljs-number">0.5f</span>)<br>                        scaleX = scale<br>                        scaleY = scale<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        pivotX = <span class="hljs-number">0f</span><br>                        <span class="hljs-keyword">val</span> scale =<br>                            MIN_SCALE + <span class="hljs-number">4f</span> * (<span class="hljs-number">1f</span> - MIN_SCALE) * (position - <span class="hljs-number">0.5f</span>) * (position - <span class="hljs-number">0.5f</span>)<br>                        scaleX = scale<br>                        scaleY = scale<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">else</span> -&gt; &#123;<br>                    <span class="hljs-comment">// This page is way off-screen to the right.</span><br>                    rotationY = MAX_ROTATION<br>                    pivotX = <span class="hljs-number">0f</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/BpNo46EwZGQaCqr.webp" srcset="/img/loading.gif" lazyload alt="img" style="zoom: 67%;" />


<table>
<thead>
<tr>
<th></th>
<th>前一个view的position变化</th>
<th>当前view的position变化</th>
<th>后一个view的position变化</th>
</tr>
</thead>
<tbody><tr>
<td>当前view右滑时</td>
<td>-1 —-&gt; 0</td>
<td>0——–&gt;1</td>
<td>1 —-&gt; +∞</td>
</tr>
<tr>
<td>当前view左滑时</td>
<td>-∞ —-&gt; -1</td>
<td>0 —–&gt; -1</td>
<td>1 ——-&gt;0</td>
</tr>
</tbody></table>
<p>  参数page是ViewPager持有的页面(包括cureent page)的rootView，position是page相对于基准参考点的偏移量，滑动过程中可标识page的偏移程度，周期为1。根据基准参考点及page页面宽度归一化的描述，在SCROLL_STATE_IDLE状态下，current page的position为0，上一页的position为-1.0，下一页的position为1.0，依此类推。</p>
<p>然后在viewPager2中设置</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">mViewPager2.setPageTransformer(SquareBoxTransformer())<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/ViewPager2-%E5%88%87%E6%8D%A2%E5%8A%A8%E7%94%BB.gif" srcset="/img/loading.gif" lazyload alt="ViewPager2-切换动画" style="zoom: 50%;" />

<h4 id="自动为布局更新添加动画"><a href="#自动为布局更新添加动画" class="headerlink" title="自动为布局更新添加动画"></a>自动为布局更新添加动画</h4><p>在 Activity 的布局 XML 文件中，针对您要启用动画的布局，将 <code>android:animateLayoutChanges</code> 属性设置为 <code>true</code>。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/container&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:animateLayoutChanges</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">...</span></span><br><span class="hljs-tag">   /&gt;</span><br></code></pre></td></tr></table></figure>

<p>在activity中</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> containerView: ViewGroup<br>   ...<br>   <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addItem</span><span class="hljs-params">()</span></span> &#123;<br>       <span class="hljs-keyword">val</span> newView: View = ...<br><br>       containerView.addView(newView, <span class="hljs-number">0</span>)<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/%E5%B8%83%E5%B1%80%E6%9B%B4%E6%96%B0%E5%8A%A8%E7%94%BB.gif" srcset="/img/loading.gif" lazyload alt="布局更新动画" style="zoom: 50%;" />





<h2 id="Compose动画-补充"><a href="#Compose动画-补充" class="headerlink" title="Compose动画[补充]"></a>Compose动画[补充]</h2><h3 id="为简单的值变化添加动画效果"><a href="#为简单的值变化添加动画效果" class="headerlink" title="为简单的值变化添加动画效果"></a>为简单的值变化添加动画效果</h3><blockquote>
<p>切换标签页，内容的背景颜色会发生变化。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> backgroundColor = <span class="hljs-keyword">if</span> (tabPage == TabPage.Home) Purple100 <span class="hljs-keyword">else</span> Green300<br></code></pre></td></tr></table></figure>

<p>如果需要为简单值变化添加动画效果，可以使用 <code>animate*AsState</code> .这里使用<code>animateColorAsState</code>可组合向，创建动画值。</p>
<p>注意:返回的值是 <code>State&lt;T&gt;</code> 对象，可以使用包含 <code>by</code> 声明的本地委托属性，将该值视为普通变量。<code>Compose</code>中都会把State<T>对象使用by委托属性</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> backgroundColor <span class="hljs-keyword">by</span> animateColorAsState(<span class="hljs-keyword">if</span> (tabPage == TabPage.Home) Purple100 <span class="hljs-keyword">else</span> Green300)<br></code></pre></td></tr></table></figure>

<p>效果图:颜色变化</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/XqHFONVlIwhcURk.gif" srcset="/img/loading.gif" lazyload alt="Compose-animateColorAsState" width="250dp" />
</blockquote>
<h3 id="为可见性添加动画效果"><a href="#为可见性添加动画效果" class="headerlink" title="为可见性添加动画效果"></a>为可见性添加动画效果</h3><blockquote>
<p>使用 <code>if</code> 语句显示或隐藏”Edit”的文本。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">if</span> (extended) &#123;<br>Text(<br>  text = stringResource(R.string.edit),<br>  modifier = Modifier<br>      .padding(start = <span class="hljs-number">8.</span>dp, top = <span class="hljs-number">3.</span>dp)<br>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>为可见性变化添加动画，将 <code>if</code> 替换为 <code>AnimatedVisibility</code> 可组合项。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">AnimatedVisibility(extended) &#123;<br>Text(<br>  text = stringResource(R.string.edit),<br>  modifier = Modifier<br>      .padding(start = <span class="hljs-number">8.</span>dp, top = <span class="hljs-number">3.</span>dp)<br>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>效果图:FAB的展开</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/WzescPJXxM7lGrI.gif" srcset="/img/loading.gif" lazyload alt="Compose-AnimatedVisibility" style="zoom:33%;" />

<p>默认情况下，<code>AnimatedVisibility</code> 会以淡入和展开的方式显示元素，以淡出和缩小的方式隐藏元素。</p>
</blockquote>
<blockquote>
<p>接下来自定义可见性动画，从而让元素从顶部滑入，然后滑出到顶部。</p>
<p>将<code>enter</code> 和 <code>exit</code> 参数添加到 <code>AnimatedVisibility</code> 可组合项中。</p>
<p><code>enter</code> 参数是 <code>EnterTransition</code> 的实例。使用 <code>slideInVertically</code> 函数创建 <code>EnterTransition</code>。<code>initialOffsetY</code> 参数是返回初始位置的 lambda。lambda 会收到一个表示元素高度的参数，只需返回其负值即可。使用 <code>slideInVertically</code> 时，滑入后的目标偏移量始终为 <code>0</code>（像素）。可使用 lambda 函数将 <code>initialOffsetY</code> 指定为绝对值或元素全高度的百分比。</p>
<p><code>animationSpec</code> 是指定动画值应如何随时间变化。这里，用 <code>tween</code> 函数创建, 时长为 150 毫秒，加&#x2F;减速选项为 <code>LinearOutSlowInEasing</code>。</p>
<p>同理，可以对 <code>exit</code> 参数使用 <code>slideOutVertically</code> 函数。<code>slideOutVertically</code> 假定初始偏移量为 0，只需指定 <code>targetOffsetY</code>。使 <code>tween</code> 函数，但时长为 250 毫秒，加&#x2F;减速选项为 <code>FastOutLinearInEasing</code>。</p>
<p>生成的代码应如下所示。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Kotlin">AnimatedVisibility(<br>visible = shown,<br>enter = slideInVertically(<br>  <span class="hljs-comment">// Enters by sliding down from offset -fullHeight to 0.</span><br>  initialOffsetY = &#123; fullHeight -&gt; -fullHeight &#125;,<br>  animationSpec = tween(durationMillis = <span class="hljs-number">150</span>, easing = LinearOutSlowInEasing)<br>),<br>exit = slideOutVertically(<br>  <span class="hljs-comment">// Exits by sliding up from offset 0 to -fullHeight.</span><br>  targetOffsetY = &#123; fullHeight -&gt; -fullHeight &#125;,<br>  animationSpec = tween(durationMillis = <span class="hljs-number">250</span>, easing = FastOutLinearInEasing)<br>)<br>) &#123;<br>Surface(<br>  modifier = Modifier.fillMaxWidth(),<br>  color = MaterialTheme.colors.secondary,<br>  elevation = <span class="hljs-number">4.</span>dp<br>) &#123;<br>  Text(<br>      text = stringResource(R.string.edit_message),<br>      modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)<br>  )<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>效果图:消息现在是从顶部滑入和滑出。</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/uoXHKFhv7nsBc9V.gif" srcset="/img/loading.gif" lazyload alt="Compose-AnimatedVisibility-Custom" style="zoom:33%;" />
</blockquote>
<h3 id="为内容大小添加动画效果"><a href="#为内容大小添加动画效果" class="headerlink" title="为内容大小添加动画效果"></a>为内容大小添加动画效果</h3><blockquote>
<p>当正文显示或隐藏时，包含文本的卡片会展开或缩小。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Column(<br>modifier = Modifier<br>  .fillMaxWidth()<br>  .padding(<span class="hljs-number">16.</span>dp)<br>) &#123;<br><span class="hljs-comment">// ... the title and the body</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>此处的这个 <code>Column</code> 可组合项会在内容发生变化时更改其大小。添加 <code>animateContentSize</code> 修饰符，为其大小变化添加动画效果。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Column(<br>modifier = Modifier<br>  .fillMaxWidth()<br>  .padding(<span class="hljs-number">16.</span>dp)<br>  .animateContentSize()<br>) &#123;<br><span class="hljs-comment">// ... the title and the body</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/mvVMbNucZqQY1Wd.gif" srcset="/img/loading.gif" lazyload alt="Compose-animateContentSize" style="zoom:33%;" />
</blockquote>
<h3 id="多值动画"><a href="#多值动画" class="headerlink" title="多值动画"></a>多值动画</h3><blockquote>
<p>我们自定义了标签页指示器。它是当前所选标签页上显示的一个矩形。</p>
<p>如需同时为多个值添加动画效果，可使用 <code>Transition</code>。<code>Transition</code> 可使用 <code>updateTransition</code> 函数创建。将当前所选标签页的索引作为 <code>targetState</code> 参数传递。</p>
<p>每个动画值都可以使用 <code>Transition</code> 的 <code>animate*</code> 扩展函数进行声明。这里使用 <code>animateDp</code> 和 <code>animateColor</code>。它们会接受一个 lambda 块，可以为每个状态指定目标值。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> transition = updateTransition(tabPage)<br><span class="hljs-keyword">val</span> indicatorLeft <span class="hljs-keyword">by</span> transition.animateDp &#123; page -&gt;<br>tabPositions[page.ordinal].left<br>&#125;<br><span class="hljs-keyword">val</span> indicatorRight <span class="hljs-keyword">by</span> transition.animateDp &#123; page -&gt;<br>tabPositions[page.ordinal].right<br>&#125;<br><span class="hljs-keyword">val</span> color <span class="hljs-keyword">by</span> transition.animateColor &#123; page -&gt;<br><span class="hljs-keyword">if</span> (page == TabPage.Home) Purple700 <span class="hljs-keyword">else</span> Green800<br>&#125;<br></code></pre></td></tr></table></figure>

<p>效果图: 点击标签页会更改 <code>tabPage</code> 状态的值，这时与 <code>transition</code> 关联的所有动画值会开始以动画方式切换至为目标状态指定的值。</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/xt2P8iQW5mXjfwv.gif" srcset="/img/loading.gif" lazyload alt="Compose-Transition-多值动画1" style="zoom:33%;" />

<p>此外，可以指定 <code>transitionSpec</code> 参数来自定义动画行为。例如可以让靠近目标页面的一边比另一边移动得更快来实现指示器的弹性效果。可以在 <code>transitionSpec</code>中使用 <code>isTransitioningTo</code> infix 函数来确定状态变化的方向。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> transition = updateTransition(<br>tabPage,<br>label = <span class="hljs-string">&quot;Tab indicator&quot;</span><br>)<br><span class="hljs-keyword">val</span> indicatorLeft <span class="hljs-keyword">by</span> transition.animateDp(<br>transitionSpec = &#123;<br>  <span class="hljs-keyword">if</span> (TabPage.Home isTransitioningTo TabPage.Work) &#123;<br>      <span class="hljs-comment">// Indicator moves to the right.</span><br>      <span class="hljs-comment">// The left edge moves slower than the right edge.</span><br>      spring(stiffness = Spring.StiffnessVeryLow)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// Indicator moves to the left.</span><br>      <span class="hljs-comment">// The left edge moves faster than the right edge.</span><br>      spring(stiffness = Spring.StiffnessMedium)<br>  &#125;<br>&#125;,<br>label = <span class="hljs-string">&quot;Indicator left&quot;</span><br>) &#123; page -&gt;<br>tabPositions[page.ordinal].left<br>&#125;<br><span class="hljs-keyword">val</span> indicatorRight <span class="hljs-keyword">by</span> transition.animateDp(<br>transitionSpec = &#123;<br>  <span class="hljs-keyword">if</span> (TabPage.Home isTransitioningTo TabPage.Work) &#123;<br>      <span class="hljs-comment">// Indicator moves to the right</span><br>      <span class="hljs-comment">// The right edge moves faster than the left edge.</span><br>      spring(stiffness = Spring.StiffnessMedium)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// Indicator moves to the left.</span><br>      <span class="hljs-comment">// The right edge moves slower than the left edge.</span><br>      spring(stiffness = Spring.StiffnessVeryLow)<br>  &#125;<br>&#125;,<br>label = <span class="hljs-string">&quot;Indicator right&quot;</span><br>) &#123; page -&gt;<br>tabPositions[page.ordinal].right<br>&#125;<br><span class="hljs-keyword">val</span> color <span class="hljs-keyword">by</span> transition.animateColor(<br>label = <span class="hljs-string">&quot;Border color&quot;</span><br>) &#123; page -&gt;<br><span class="hljs-keyword">if</span> (page == TabPage.Home) Purple700 <span class="hljs-keyword">else</span> Green800<br>&#125;<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/TGzJo72are9R63b.gif" srcset="/img/loading.gif" lazyload alt="Compose-Transition-多值动画2" style="zoom:33%;" />

<p>Android Studio 支持在 Compose 预览中检查过渡效果。如需使用<strong>动画预览</strong>，请在预览中点击可组合项右上角的“Start interactive mode”图标，以开始交互模式。</p>
</blockquote>
<h3 id="重复动画"><a href="#重复动画" class="headerlink" title="重复动画"></a>重复动画</h3><blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> alpha = <span class="hljs-number">1f</span><br></code></pre></td></tr></table></figure>

<p><code>InfiniteTransition</code>可以实现重复动画,先使用 <code>rememberInfiniteTransition</code> 函数。然后，可以使用 <code>InfiniteTransition</code> 的一个 <code>animate*</code> 扩展函数声明每个动画值变化。这里为 Alpha 值添加动画效果，<code>initialValue</code> 参数应为 <code>0f</code>，而 <code>targetValue</code> 应为 <code>1f</code>。然后为动画指定 <code>InfiniteRepeatableSpec</code>,使其重复。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> infiniteTransition = rememberInfiniteTransition()<br><span class="hljs-keyword">val</span> alpha <span class="hljs-keyword">by</span> infiniteTransition.animateFloat(<br>initialValue = <span class="hljs-number">0f</span>,<br>targetValue = <span class="hljs-number">1f</span>,<br>animationSpec = infiniteRepeatable(<br>animation = keyframes &#123;<br>    durationMillis = <span class="hljs-number">1000</span><br>      <span class="hljs-number">0.7f</span> at <span class="hljs-number">500</span><br>  &#125;,<br>  repeatMode = RepeatMode.Reverse<br>)<br>)<br></code></pre></td></tr></table></figure>

<p>效果图:</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/aCVpfHsGh9w4QOZ.gif" srcset="/img/loading.gif" lazyload alt="Compose-InfiniteTransition" style="zoom:33%;" />
</blockquote>
<h3 id="手势动画"><a href="#手势动画" class="headerlink" title="手势动画"></a>手势动画</h3><blockquote>
<p>将动画值与来自触摸事件的值同步。</p>
<p>创建一个修饰符，以使触摸时元素可滑动。当元素被快速滑动到屏幕边缘时，调用 <code>onDismissed</code> 回调，移除该元素。</p>
<p><code>Animatable</code>可表示滑动元素的水平偏移量。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> offsetX = remember &#123; Animatable(<span class="hljs-number">0f</span>) &#125; /<br>pointerInput &#123;<br><span class="hljs-comment">// Used to calculate a settling position of a fling animation.</span><br><span class="hljs-keyword">val</span> decay = splineBasedDecay&lt;<span class="hljs-built_in">Float</span>&gt;(<span class="hljs-keyword">this</span>)<br><span class="hljs-comment">// Wrap in a coroutine scope to use suspend functions for touch events and animation.</span><br>coroutineScope &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>      <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure>

<p>如果动画当前正在运行，应将其拦截。可以通过调用 Animatable的stop() 来实现</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// Wait for a touch down event.</span><br><span class="hljs-keyword">val</span> pointerId = awaitPointerEventScope &#123; awaitFirstDown().id &#125;<br>offsetX.stop() <br><span class="hljs-comment">// Prepare for drag events and record velocity of a fling.</span><br><span class="hljs-keyword">val</span> velocityTracker = VelocityTracker()<br><span class="hljs-comment">// Wait for drag events.</span><br>awaitPointerEventScope &#123;<br></code></pre></td></tr></table></figure>

<p>不断接收到拖动事件。必须将触摸事件的位置同步到动画值中。使用Animatable的snapTo。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">horizontalDrag(pointerId) &#123; change -&gt;<br><span class="hljs-comment">// Add these 4 lines</span><br><span class="hljs-keyword">val</span> horizontalDragOffset = offsetX.value + change.positionChange().x<br>launch &#123;<br>  offsetX.snapTo(horizontalDragOffset)<br>&#125;<br><span class="hljs-comment">// Record the velocity of the drag.</span><br>velocityTracker.addPosition(change.uptimeMillis, change.position)<br><span class="hljs-comment">// Consume the gesture event, not passed to external</span><br>change.consumePositionChange()<br>&#125;<br></code></pre></td></tr></table></figure>

<p>计算快速滑动操作的最终位置，确定是要将元素滑回原始位置，还是滑开元素</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// Dragging finished. Calculate the velocity of the fling.</span><br><span class="hljs-keyword">val</span> velocity = velocityTracker.calculateVelocity().x<br><span class="hljs-comment">// Add this line</span><br><span class="hljs-keyword">val</span> targetOffsetX = decay.calculateTargetValue(offsetX.value, velocity)<br></code></pre></td></tr></table></figure>

<p>为 <code>Animatable</code> 设置值的上下界限，使到达界限时立即停止。使用 <code>pointerInput</code> 修饰符，可以通过 <code>size</code> 属性访问元素的大小,获取界限。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">offsetX.updateBounds(<br>lowerBound = -size.width.toFloat(),<br>upperBound = size.width.toFloat()<br>)<br></code></pre></td></tr></table></figure>

<p>首先来比较之前计算的快速滑动操作的最终位置以及元素的大小。如果最终位置低于该大小，则表示快速滑动的速度不够。使用 <code>animateTo</code> 将值的动画效果设置回 0f。否则，可以使用 <code>animateDecay</code> 来开始播放快速滑动动画。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">launch &#123;<br><span class="hljs-keyword">if</span> (targetOffsetX.absoluteValue &lt;= size.width) &#123;<br>  <span class="hljs-comment">// Not enough velocity; Slide back.</span><br>  offsetX.animateTo(targetValue = <span class="hljs-number">0f</span>, initialVelocity = velocity)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// Enough velocity to slide away the element to the edge.</span><br>  offsetX.animateDecay(velocity, decay)<br>  <span class="hljs-comment">// The element was swiped away.</span><br>  onDismissed()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后对元素应用偏移。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">.offset &#123; IntOffset(offsetX.value.roundToInt(), <span class="hljs-number">0</span>) &#125;<br></code></pre></td></tr></table></figure>

<p>最终代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> Modifier.<span class="hljs-title">swipeToDismiss</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">onDismissed: () -&gt; <span class="hljs-type">Unit</span></span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span>: Modifier = composed &#123;<br><span class="hljs-comment">// This `Animatable` stores the horizontal offset for the element.</span><br><span class="hljs-keyword">val</span> offsetX = remember &#123; Animatable(<span class="hljs-number">0f</span>) &#125;<br>pointerInput(<span class="hljs-built_in">Unit</span>) &#123;<br>  <span class="hljs-comment">// Used to calculate a settling position of a fling animation.</span><br>  <span class="hljs-keyword">val</span> decay = splineBasedDecay&lt;<span class="hljs-built_in">Float</span>&gt;(<span class="hljs-keyword">this</span>)<br>  <span class="hljs-comment">// Wrap in a coroutine scope to use suspend functions for touch events and animation.</span><br>  coroutineScope &#123;<br>      <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>          <span class="hljs-comment">// Wait for a touch down event.</span><br>          <span class="hljs-keyword">val</span> pointerId = awaitPointerEventScope &#123; awaitFirstDown().id &#125;<br>          <span class="hljs-comment">// Interrupt any ongoing animation.</span><br>          offsetX.stop()<br>          <span class="hljs-comment">// Prepare for drag events and record velocity of a fling.</span><br>          <span class="hljs-keyword">val</span> velocityTracker = VelocityTracker()<br>          <span class="hljs-comment">// Wait for drag events.</span><br>          awaitPointerEventScope &#123;<br>              horizontalDrag(pointerId) &#123; change -&gt;<br>                  <span class="hljs-comment">// Record the position after offset</span><br>                  <span class="hljs-keyword">val</span> horizontalDragOffset = offsetX.value + change.positionChange().x<br>                  launch &#123;<br>                      <span class="hljs-comment">// Overwrite the `Animatable` value while the element is dragged.</span><br>                      offsetX.snapTo(horizontalDragOffset)<br>                  &#125;<br>                  <span class="hljs-comment">// Record the velocity of the drag.</span><br>                  velocityTracker.addPosition(change.uptimeMillis, change.position)<br>                  <span class="hljs-comment">// Consume the gesture event, not passed to external</span><br>                  change.consumePositionChange()<br>              &#125;<br>          &#125;<br>          <span class="hljs-comment">// Dragging finished. Calculate the velocity of the fling.</span><br>          <span class="hljs-keyword">val</span> velocity = velocityTracker.calculateVelocity().x<br>          <span class="hljs-comment">// Calculate where the element eventually settles after the fling animation.</span><br>          <span class="hljs-keyword">val</span> targetOffsetX = decay.calculateTargetValue(offsetX.value, velocity)<br>          <span class="hljs-comment">// The animation should end as soon as it reaches these bounds.</span><br>          offsetX.updateBounds(<br>              lowerBound = -size.width.toFloat(),<br>              upperBound = size.width.toFloat()<br>          )<br>          launch &#123;<br>              <span class="hljs-keyword">if</span> (targetOffsetX.absoluteValue &lt;= size.width) &#123;<br>                  <span class="hljs-comment">// Not enough velocity; Slide back to the default position.</span><br>                  offsetX.animateTo(targetValue = <span class="hljs-number">0f</span>, initialVelocity = velocity)<br>              &#125; <span class="hljs-keyword">else</span> &#123;<br>                  <span class="hljs-comment">// Enough velocity to slide away the element to the edge.</span><br>                  offsetX.animateDecay(velocity, decay)<br>                  <span class="hljs-comment">// The element was swiped away.</span><br>                  onDismissed()<br>              &#125;<br>          &#125;<br>      &#125;<br>  &#125;<br>&#125;<br>  <span class="hljs-comment">// Apply the horizontal offset to the element.</span><br>  .offset &#123; IntOffset(offsetX.value.roundToInt(), <span class="hljs-number">0</span>) &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>效果图:滑动删除</p>
<img src="https://typora-1256766878.cos.ap-chongqing.myqcloud.com/img/ADLPQNUysHxIpz1.png" srcset="/img/loading.gif" lazyload alt="Compose-Animatable-手势动画" style="zoom:25%;" />
</blockquote>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><blockquote>
<ul>
<li>使用<code>animateContentSize</code> 和 <code>AnimatedVisibility</code> 构建几种常见的动画模式。</li>
<li>使用 <code>animate*AsState</code> 为单个值添加动画效果</li>
<li>使用 <code>updateTransition</code> 为多个值添加动画效果</li>
<li>使用 <code>infiniteTransition</code> 为多个值无限期地添加动画效果 </li>
<li>使用 <code>Animatable</code> 构建了与触摸手势相结合的自定义动画。</li>
</ul>
</blockquote>
<p>参考文章:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/codelabs/jetpack-compose-animation?continue=https://developer.android.google.cn/courses/pathways/compose%23codelab-https://developer.android.com/codelabs/jetpack-compose-animation#8">Jetpack Compose 动画 </a></li>
<li>[Anroid自定义控件开发入门与实战-启舰]</li>
</ul>
<p>本文源码已上传github: <a target="_blank" rel="noopener" href="https://github.com/WhiteNight123/AnimationDemo">WhiteNight123&#x2F;AnimationDemo (github.com)</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div></div>
      <div>http://example.com/2022/10/19/动画相关/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>October 19, 2022</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>Licensed under</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/19/%E8%87%AA%E5%AE%9A%E4%B9%89View/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/08/%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91/" title="事件分发">
                        <span class="hidden-mobile">事件分发</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
